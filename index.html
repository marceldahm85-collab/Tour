<!DOCTYPE html>
<html lang="de">
<head>
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Nunito&display=swap" rel="stylesheet">
<meta name="theme-color" content="#0b0f14">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bergtouren Tracker</title>
<style>
* { box-sizing:border-box; margin:0; padding:0; }
body {
    min-height:100vh;
    font-family:'Nunito',sans-serif;
    display:flex;
    justify-content:center;
    padding:50px 20px;
    overflow-x:hidden;
    background: linear-gradient(180deg, hsl(200,50%,70%) 0%, hsl(180,40%,70%) 50%, #e6e3df 100%);
}

/* Parallax Berge */
.parallax { position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; overflow:hidden; z-index:-1; }
.layer { position:absolute; bottom:0; width:200%; height:50%; }
.layer1 { background: rgba(70,100,70,0.3); clip-path: polygon(0% 100%,5% 70%,10% 75%,15% 60%,20% 80%,30% 65%,40% 85%,50% 60%,60% 78%,70% 55%,80% 80%,90% 70%,100% 100%); z-index:1; }
.layer2 { background: rgba(90,120,90,0.5); clip-path: polygon(0% 100%,7% 75%,15% 65%,25% 80%,35% 60%,45% 78%,55% 55%,65% 70%,75% 60%,85% 80%,100% 100%); z-index:2; }
.layer3 { background: rgba(110,140,110,0.7); clip-path: polygon(0% 100%,10% 70%,20% 60%,30% 75%,40% 55%,50% 70%,60% 60%,70% 75%,80% 55%,90% 70%,100% 100%); z-index:3; }

/* Sonnenaufgang */
.sun { position:absolute; bottom:20%; left:50%; width:400px; height:400px; background: radial-gradient(circle, rgba(255,223,128,0.5) 0%, transparent 60%); border-radius:50%; transform:translateX(-50%); opacity:0.7; animation: sunGlow 10s ease-in-out infinite alternate; z-index:0; }
@keyframes sunGlow { 0% {transform:translateX(-50%) scale(0.95); opacity:0.6;} 50% {transform:translateX(-50%) scale(1.05); opacity:0.8;} 100% {transform:translateX(-50%) scale(0.98); opacity:0.7;} }

/* Wolken */
.cloud { position:absolute; width:200px; height:60px; background: rgba(255,255,255,0.5); border-radius:50%; filter:blur(4px); }
.cloud-layer1 { top:10%; animation: cloudMove1 linear infinite; }
.cloud-layer2 { top:20%; animation: cloudMove2 linear infinite; }
.cloud-layer3 { top:30%; animation: cloudMove3 linear infinite; }
@keyframes cloudMove1 { 0% {transform:translateX(0);} 100% {transform:translateX(140vw);} }
@keyframes cloudMove2 { 0% {transform:translateX(0);} 100% {transform:translateX(140vw);} }
@keyframes cloudMove3 { 0% {transform:translateX(0);} 100% {transform:translateX(140vw);} }

/* Accordion */
.box { backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); background: rgba(255,255,255,0.25); border-radius:18px; border:1px solid rgba(255,255,255,0.3); box-shadow:0 12px 28px rgba(40,60,50,0.25), inset 0 1px 1px rgba(255,255,255,0.35); overflow:hidden; transition:transform 0.35s ease, box-shadow 0.35s ease; position:relative; }
.box:hover { transform:translateY(-2px); box-shadow:0 18px 40px rgba(40,60,50,0.35), inset 0 1px 1px rgba(255,255,255,0.45); }
.box-header { padding:24px 28px; display:flex; align-items:center; justify-content:space-between; cursor:pointer; color:#2e4036; font-weight:600; }
.arrow { width:18px; height:18px; border-right:2px solid #f9d77e; border-bottom:2px solid #f9d77e; transform:rotate(45deg); transition:transform 0.45s cubic-bezier(.4,0,.2,1); margin-top:-2px; }
.box.active .arrow { transform:rotate(-135deg); }
.box-content { max-height:0; opacity:0; overflow:hidden; padding:0 28px; color:#3f5248; transition: max-height 0.65s cubic-bezier(.4,0,.2,1), opacity 0.45s ease; position:relative; }
.box.active .box-content { max-height:2000px; opacity:1; padding-bottom:28px; }
.box::before { content:""; position:absolute; top:-10px; left:-10px; right:-10px; bottom:-10px; background:radial-gradient(circle at top center, rgba(255,223,128,0.3), transparent 60%); opacity:0; transition:opacity 0.5s ease; border-radius:22px; pointer-events:none; }
.box.active::before { opacity:1; }
.box-content p { margin:0; line-height:1.7; animation: gentleWind 6s ease-in-out infinite alternate; }
@keyframes gentleWind { 0% {transform:translateX(0);} 100% {transform:translateX(2px);} }

/* Formular */
.tour-form { display:flex; flex-direction:column; gap:16px; }
@media (max-width: 768px) {
    .tour-form select {
        width: 100%;
        min-width: 0;
    }
    .form-group,
    .form-row {
        width: 100%;
        max-width: 100%;
    }
}
.form-group { display:flex; flex-direction:column; gap:6px; }
.tour-form label { font-weight:500; color:#2e4036; }
.tour-form input, .tour-form select { padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.5); background:rgba(255,255,255,0.2); color:#2e4036; font-size:clamp(12px,1.2vw,16px); outline:none; transition: background 0.3s ease, border 0.3s ease; backdrop-filter: blur(10px); }
.tour-form input:focus, .tour-form select:focus { background:rgba(255,255,255,0.35); border-color:#f9d77e; }

/* Speicher-Button */
button.save-btn { margin-top:10px; padding:10px 16px; border:none; border-radius:12px; background:#f9d77e; color:#2e4036; font-weight:600; cursor:pointer; transition:transform 0.2s ease; }
button.save-btn:hover { transform:scale(1.05); }

/* Tabelle */
#overview-table-wrapper { overflow: hidden; border-radius: 16px; backdrop-filter: blur(10px); background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); transform: translateY(10px); opacity: 0; transition: transform 0.5s ease, opacity 0.5s ease; }
.box.active #overview-table-wrapper { transform: translateY(0); opacity: 1; }
#overview-table { width:100%; border-collapse: separate; border-spacing:0; table-layout:auto; font-size: clamp(12px,1vw,14px); border-radius: 16px; overflow: hidden; }
#overview-table th, #overview-table td { padding:6px 10px; border: 1px solid rgba(255,255,255,0.5); border-radius: 12px; background: rgba(255,255,255,0.15); word-wrap: break-word; overflow-wrap: break-word; white-space: nowrap; }
#overview-table th { background: rgba(255,255,255,0.25); font-weight:600; }
#overview-table tbody tr:nth-child(even) { background: rgba(255,255,255,0.12); }
#overview-table tbody tr:hover td { background: rgba(255,255,255,0.25); }

/* Aktion-Spalte und L√∂schen-Button */
#overview-table th:nth-child(8), #overview-table td:nth-child(8) { min-width:50px; text-align:center; white-space: normal; }
.delete-btn { background: rgba(255,50,50,0.2); border:none; border-radius:50%; width:28px; height:28px; cursor:pointer; font-weight:bold; color:#ff3333; transition: transform 0.2s ease, background 0.2s ease; display:inline-flex; align-items:center; justify-content:center; padding:0; }
.delete-btn:hover { transform: scale(1.2); background: rgba(255,50,50,0.35); }

/* ---------------- Load-Button (Tour √ºbernehmen) ---------------- */
.load-btn {
    background: rgba(50,150,255,0.2); /* Blaue Variante f√ºr neutralen Look */
    border: none;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    cursor: pointer;
    font-weight: bold;
    color: #2196f3;
    transition: transform 0.2s ease, background 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    margin-right: 4px; /* Abstand zum Delete-Button */
}

.load-btn:hover {
    transform: scale(1.2);
    background: rgba(50,150,255,0.35);
}

/* Glow f√ºr Statistik */
.stats-glow { animation: glowAnim 1.0s ease-in-out; }
@keyframes glowAnim { 0% { text-shadow:0 0 0 rgba(249,215,126,0); color:#2e4036;} 50% { text-shadow:0 0 12px rgba(249,215,126,0.8); color:#f9d77e;} 100% { text-shadow:0 0 0 rgba(249,215,126,0); color:#2e4036;} }

.gipfel-accordion {
    margin-top: 8px;
    padding: 10px 14px;
    border-radius: 12px;
    background: rgba(255,255,255,0.22);
    display: none;
    animation: fadeSlide 0.4s ease;
}

@keyframes fadeSlide {
    from { opacity:0; transform: translateY(-6px); }
    to   { opacity:1; transform: translateY(0); }
}

.gipfel-accordion p {
    margin: 4px 0;
    font-size: 0.9em;
}

body.dark {
    background: linear-gradient(
        180deg,
        hsl(220,40%,20%) 0%,
        hsl(220,30%,15%) 50%,
        #0b0f14 100%
    );
}
body.dark .layer1 { background: rgba(30,40,50,0.5); }
body.dark .layer2 { background: rgba(20,30,40,0.65); }
body.dark .layer3 { background: rgba(10,20,30,0.8); }
body.dark .sun {
    background: radial-gradient(
        circle,
        rgba(220,230,255,0.35) 0%,
        rgba(220,230,255,0.15) 40%,
        transparent 65%
    );
    opacity: 0.8;
    filter: blur(1px);
}
body.dark .cloud {
    background: rgba(180,200,255,0.15);
}
body.dark .box {
    background: rgba(20,30,40,0.45);
    border: 1px solid rgba(255,255,255,0.08);
    box-shadow:
        0 14px 32px rgba(0,0,0,0.6),
        inset 0 1px 1px rgba(255,255,255,0.05);
}

body.dark .box-header,
body.dark .box-content {
    color: #d6e1f0;
}

body.dark .arrow {
    border-color: #7a0d0d;
}

body.dark input::placeholder {
    color: rgba(220,230,255,0.5);
}
body.dark #overview-table th,
body.dark #overview-table td {
    background: rgba(255,255,255,0.06);
    color: #d6e1f0;
    border-color: rgba(255,255,255,0.12);
}

body.dark #overview-table tbody tr:hover td {
    background: rgba(255,255,255,0.12);
}
body.dark .gipfel-accordion {
    background: rgba(255,255,255,0.08);
    border-left: 3px solid #7a0d0d;
}
.stats-filters {
    margin: 4px;
    display: flex;
    gap: 12px;
    justify-content: flex-start;
    flex-wrap: wrap;
}

.stats-filters select {
    padding: 8px 12px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.35);
    background: rgba(255,255,255,0.15);
    color: #2e4036;
    font-weight: 500;
    outline: none;
    transition: background 0.3s ease, border 0.3s ease;
    backdrop-filter: blur(8px);
}

.stats-filters select:focus {
    background: rgba(255,255,255,0.25);
    border-color: #f9d77e;
}

body.dark .stats-filters select {
    background: rgba(255,255,255,0.08);
    border-color: rgba(255,255,255,0.12);
    color: #d6e1f0;
}
/* Darkmode Dropdowns */
body.dark select,
body.dark input:not([type="checkbox"]) {
    color: #1e1e1e; /* dunkle Schrift */
}

body.dark option {
    color: #1e1e1e; /* Option-Texte ebenfalls dunkel */
    background: rgba(255,255,255,0.15); /* optional leichter Hintergrund */
}
body.dark select:focus {
    background: rgba(255,255,255,0.25);
    border-color: #f9d77e;
    color: #1e1e1e;
}
/* Alle Dropdowns im Dark Mode */
body.dark select,
body.dark input:not([type="checkbox"]) {
    color: #1e1e1e; /* dunkle Schrift im Auswahlfeld */
    background: rgba(255,255,255,0.08); /* Glasiger Hintergrund */
}

body.dark select option {
    color: #1e1e1e; /* Textfarbe der Optionen */
    background: rgba(255,255,255,0.15); /* leichte Transparenz f√ºr Optionen */
}

/* Fokus-Effekt f√ºr alle Inputs & Selects */
body.dark select:focus,
body.dark input:not([type="checkbox"]):focus {
    background: rgba(255,255,255,0.25);
    border-color: #f9d77e;
    color: #1e1e1e;
}
/* Box 1 ‚Äì Formular-Labels im Dark Mode aufhellen */
body.dark .tour-form label {
    color: #f1e3b0;
    font-weight: 500;
    text-shadow: 0 0 4px rgba(159,182,255,0.35);
}

/* √úberschrift */
.app-title {
    font-size: clamp(22px, 4vw, 28px);
    font-weight: 700;
    color: #2e4036;
    letter-spacing: 0.5px;
}

/* Dark Mode Titel */
body.dark .app-title {
    color: #d6e1f0;
    text-shadow: 0 0 8px rgba(159,182,255,0.35);
}

/* Toggle Button ‚Äì nicht mehr fixed */
#theme-toggle {
    position: static;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: none;
    background: #f9d77e;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    transition: transform 0.2s ease, background 0.3s ease;
    z-index: 999;
}
#theme-toggle:hover { transform: scale(1.1); background: #fbd86d; }
body.dark #theme-toggle { background: #4e0a0a; }
body.dark #theme-toggle:hover { background: #7a0d0d; }
/* Zentrierter App-Wrapper */
.app-wrapper {
    width: 100%;
    max-width: 900px;
    margin: 0 auto;
}

.toggle-btn {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: none;
    background: #f9d77e;
    cursor: pointer;

    display: flex;
    align-items: center;
    justify-content: center;

    font-size: 20px;
    line-height: 1;

    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    transition: transform 0.2s ease, background 0.3s ease;
}

.toggle-btn:hover {
    transform: scale(1.1);
    background: #fbd86d;
}

/* Dark Mode */
body.dark .toggle-btn {
    background: #4e0a0a;
}

body.dark .toggle-btn:hover {
    background: #7a0d0d;
}

/* Header fest oben im Flow */
.accordion-header {
    width: 100%;
    max-width: 700px;
    padding: 0 16px;
    display: grid;
    grid-template-columns: 1fr auto;
    align-items: center;
    margin-bottom: 24px;
    position: relative;
    top: 16px;
    z-index: 10;
}

/* Accordion separat */
.accordion {
    display: flex;
    flex-direction: column;
    gap: 24px;
    width: 100%;
}

.app-title {
    text-align: center;
}

/* =========================
   Has-Peak Checkbox ‚Äì richtig rund + Darkmode
   ========================= */
.has-peak-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    font-size: clamp(12px,1.2vw,14px);
    color: #2e4036; /* Standardfarbe */
    cursor: pointer;
}

.has-peak-label input[type="checkbox"] {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    cursor: pointer;

    /* WICHTIG: native Darstellung komplett abschalten */
    -webkit-appearance: none;
    appearance: none;

    /* Anfangszustand: nur Rahmen, leicht transparent */
    background: transparent;
    border: 2px solid #f9d77e;

    position: relative;
    display: inline-block;
    vertical-align: middle;

    transition: background 0.15s ease, border-color 0.15s ease, transform 0.1s ease;
}

/* Checked Effekt: goldener Punkt */
.has-peak-label input[type="checkbox"]:checked {
    background: #f9d77e;
    border-color: #f9d77e;
}

/* Optional: kleiner dunkler Punkt/Haken in der Mitte */
.has-peak-label input[type="checkbox"]:checked::after {
    content: "";
    position: absolute;
    inset: 5px;                 /* Abstand zum Rand, erzeugt einen Kreis innen */
    border-radius: 50%;
    background: #2e4036;        /* dunkler Punkt */
}

/* Hover Effekt */
.has-peak-label input[type="checkbox"]:hover {
    background: rgba(255,255,255,0.35);
}

/* Darkmode nur f√ºr diese Checkbox und Label */
body.dark .has-peak-label {
    color: #d6e1f0; /* Label hell */
}

body.dark .has-peak-label input[type="checkbox"] {
    background: rgba(255,255,255,0.08);
    border: 1.5px solid rgba(255,255,255,0.15);
}

body.dark .has-peak-label input[type="checkbox"]:checked {
    background: #f9d77e;
    border-color: #f9d77e;
}

body.dark .has-peak-label input[type="checkbox"]:hover {
    background: rgba(255,255,255,0.15);
}

/* WICHTIG: Globale Darkmode-Input-Regeln NICHT auf Checkbox anwenden */
body.dark input:not([type="checkbox"]),
body.dark select {
    background: rgba(255,255,255,0.08);
    color: #e0e6f0;
    border: 1px solid rgba(255,255,255,0.15);
}

body.dark input:focus, body.dark select:focus {
    background: rgba(255,255,255,0.25);
    border-color: #f9d77e;
    color: #e0e6f0;
}

/* Highlights-Layout */
.highlight-row {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    margin: 4px 0;
}

.highlight-label {
    display: inline-block;
    min-width: 190px;   /* nach Bedarf anpassen */
    font-weight: 500;
}

.highlight-value {
    flex: 1;
}

/* =========================
   BOX 6 ‚Äì BALKENDIAGRAMME
   ========================= */
.charts-wrapper {
    display: flex;
    flex-direction: column;
    gap: 18px;
    margin-top: 8px;
}

/* Auf gr√∂√üeren Screens Karten nebeneinander */
@media (min-width: 900px) {
    .charts-wrapper {
        flex-direction: row;
    }
}

.chart-card {
    flex: 1;
    padding: 10px 12px 14px;
    border-radius: 14px;
    background: rgba(255,255,255,0.18);
    border: 1px solid rgba(255,255,255,0.35);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    box-shadow: 0 8px 18px rgba(0,0,0,0.12);
    display: flex;
    flex-direction: column;
    gap: 6px;
}

body.dark .chart-card {
    background: rgba(10,18,26,0.65);
    border-color: rgba(255,255,255,0.08);
    box-shadow: 0 8px 20px rgba(0,0,0,0.6);
}

.chart-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: #2e4036;
    margin-bottom: 2px;
}

body.dark .chart-title {
    color: #d6e1f0;
}

/* Container f√ºr Balken */
.chart-bars {
    position: relative;
    height: 130px;
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    gap: 2px;
    padding: 4px 2px 0;
}

.view-container {
    width: 100%;
    display: flex;
    justify-content: center;
}

#diagram-canvas {
    width: 100%;
    height: 420px;
}

body.dark #diagram-canvas {
    background: rgba(10,18,26,0.65);
    border-color: rgba(255,255,255,0.08);
}

/* Einzelner Balken */
.chart-bar {
    flex: 1;
    max-width: 10px;
    border-radius: 999px 999px 0 0;
    background: linear-gradient(180deg, #f9d77e, rgba(249,215,126,0.1));
    box-shadow: 0 0 4px rgba(249,215,126,0.6);
    transform-origin: bottom;
    transform: scaleY(0);
    transition: transform 0.4s ease-out;
}

/* Unterschiedliche Farbakzente pro Diagramm */
#chart-distance .chart-bar {
    background: linear-gradient(180deg, #7fd1b9, rgba(127,209,185,0.12));
    box-shadow: 0 0 4px rgba(127,209,185,0.7);
}

#chart-ascent .chart-bar {
    background: linear-gradient(180deg, #f9d77e, rgba(249,215,126,0.12));
    box-shadow: 0 0 4px rgba(249,215,126,0.8);
}

#chart-time .chart-bar {
    background: linear-gradient(180deg, #9fb6ff, rgba(159,182,255,0.12));
    box-shadow: 0 0 4px rgba(159,182,255,0.7);
}

body.dark .chart-bar {
    opacity: 0.9;
}

/* X-Achse Labels */
.chart-x-axis {
    display: flex;
    justify-content: space-between;
    font-size: 0.7rem;
    margin-top: 4px;
    opacity: 0.7;
    color: #2e4036;
}

body.dark .chart-x-axis {
    color: #d6e1f0;
}

/* Kleine horizontale Hilfslinien (optional) */
.chart-bars::before,
.chart-bars::after {
    content: "";
    position: absolute;
    left: 0;
    right: 0;
    border-top: 1px dashed rgba(255,255,255,0.4);
    pointer-events: none;
}

.chart-bars::before {
    top: 33%;
    opacity: 0.4;
}
.chart-bars::after {
    top: 66%;
    opacity: 0.2;
}

body.dark .chart-bars::before,
body.dark .chart-bars::after {
    border-color: rgba(255,255,255,0.15);
}

.view-container {
    position: relative;
    min-height: 100vh;
}

.view {
position: absolute;
inset: 0;

display: flex;
flex-direction: column;
align-items: center;
gap: 16px;

    opacity: 0;
    pointer-events: none;
    transition: opacity 1s ease;
}

.view.visible {
opacity: 1;
pointer-events: auto;
}

.header-actions {
    display: flex;
    gap: 8px;
    justify-self: end;
}

#chart-view canvas {
width: 100%;
max-width: 700px;
background: rgba(127,209,185,0.25);
border-radius: 18px;
border: 1px solid rgba(255,255,255,0.3);
box-shadow: 0 12px 28px rgba(40,60,50,0.25), inset 0 1px 1px rgba(255,255,255,0.35);
backdrop-filter: blur(16px);
-webkit-backdrop-filter: blur(16px);
padding: 16px;
transition: transform 0.35s ease, box-shadow 0.35s ease;
}

#chart-view canvas:hover {
transform: translateY(-2px);
box-shadow: 0 18px 40px rgba(40,60,50,0.35), inset 0 1px 1px rgba(255,255,255,0.45);
}

body.dark #chart-view canvas {
background: rgba(20,30,40,0.45);
border: 1px solid rgba(255,255,255,0.08);
box-shadow: 0 14px 32px rgba(0,0,0,0.6), inset 0 1px 1px rgba(255,255,255,0.05);
}

/* geplante Touren ‚Äì identisch zu overview-table */
#planned-table-wrapper {
    overflow: hidden;
    border-radius: 16px;
    backdrop-filter: blur(10px);
    background: rgba(255,255,255,0.15);
    border: 1px solid rgba(255,255,255,0.3);
}

#planned-table {
    width:100%;
    border-collapse: separate;
    border-spacing:0;
    font-size: clamp(12px,1vw,14px);
}

#planned-table th,
#planned-table td {
    padding:6px 10px;
    border: 1px solid rgba(255,255,255,0.5);
    border-radius: 12px;
    background: rgba(255,255,255,0.15);
    white-space: nowrap;
}

#planned-table th {
    background: rgba(255,255,255,0.25);
    font-weight:600;
}

#planned-table tbody tr:nth-child(even) {
    background: rgba(255,255,255,0.12);
}

#planned-table tbody tr:hover td {
    background: rgba(255,255,255,0.25);
}

#planned-table td.gipfel-toggle {
    cursor: pointer;
    font-weight: 600;
}

/* =========================
   MOBILE TABLE ‚Äì MODERN CARD STYLE (ALLE TABELLEN)
   ========================= */
@media (max-width: 768px) {

    body {
        font-family: 'Nunito', sans-serif; /* hier mobile Schriftart */
    }

    /* Wrapper */
    #overview-table-wrapper,
    #planned-table-wrapper {
        overflow-x: hidden;
        width: 100%;
    }

    /* Tabellen zu Cards */
    #overview-table,
    #planned-table,
    #overview-table thead,
    #planned-table thead,
    #overview-table tbody,
    #planned-table tbody,
    #overview-table th,
    #planned-table th,
    #overview-table td,
    #planned-table td,
    #overview-table tr,
    #planned-table tr {
        display: block;
        width: 100%;
    }

    /* Header ausblenden */
    #overview-table thead,
    #planned-table thead {
        display: none;
    }

    /* Karten */
    #overview-table tr,
    #planned-table tr {
        margin-bottom: 12px;
        border-radius: 12px;
        background: rgba(255,255,255,0.9);
        backdrop-filter: blur(6px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        border: none;
    }

    body.dark #overview-table tr,
    body.dark #planned-table tr {
        background: rgba(150,255,150,0.1);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    /* Zellen */
    #overview-table td,
    #planned-table td {
        display: flex;
        justify-content: space-between;
        padding: 8px 12px;
        font-size: clamp(12px, 3vw, 14px);
        white-space: normal;
        word-break: break-word;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    body.dark #overview-table td,
    body.dark #planned-table td {
        color: #d6e1f0;
        border-bottom: 1px solid rgba(255,255,255,0.12);
    }

    #overview-table td:last-child,
    #planned-table td:last-child {
        border-bottom: none;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 6px;
    }

    /* Labels */
    #overview-table td::before,
    #planned-table td::before {
        content: attr(data-label);
        font-weight: 600;
        margin-right: 8px;
        width: 40%;
        flex-shrink: 0;
        color: #2e4036;
    }

    body.dark #overview-table td::before,
    body.dark #planned-table td::before {
        color: #d6e1f0;
    }

    /* Buttons */
    #overview-table button,
    #planned-table button {
        padding: 0.25rem 0.5rem;
        font-size: 0.9rem;
        border-radius: 6px;
    }

    /* ‚ùó Accordion-Zeile NICHT als Karte behandeln */
    tr.accordion-row {
        background: transparent !important;
        box-shadow: none !important;
        margin-top: -8px;
    }

    #overview-table td:last-child::before,
    #planned-table td:last-child::before {
        margin-right: auto;
        width: auto;
        flex-shrink: 0;
    }

    #overview-table td[data-label="Zeit"] {
        justify-items: start;
        text-align: left;
    }

}

/* Einheiten f√ºr Tabelle & Mobile Cards */
#overview-table td[data-label="Strecke"] span.value::after,
#planned-table td[data-label="Strecke"] span.value::after {
    content: " km";
}

#overview-table td[data-label="Aufstieg"] span.value::after,
#planned-table td[data-label="Aufstieg"] span.value::after {
    content: " hm";
}

#overview-table td[data-label="Zeit"] span.value::after,
#planned-table td[data-label="Zeit"] span.value::after {
    content: " Std.";
}

/* üì± Mobiler Tap-Highlight ‚Äì NUR unter 768px, rot */
@media (max-width: 768px) {
    .box {
        -webkit-tap-highlight-color: rgba(180, 20, 20, 0.4);
    }
}
#planned-tours-list .tour-list,
#saved-tours-list .tour-list {
    list-style: none;
    padding: 0;
    margin: 0;
}
#planned-tours-list .tour-list li,
#saved-tours-list .tour-list li {
    display: grid;
    grid-template-columns: 1.6em 6.8em 1fr;
    align-items: center;
    column-gap: 8px;

    padding: 8px 12px;
    margin-bottom: 4px;
    background: rgba(255,255,255,0.15);
    border-radius: 10px;
}
body.dark #planned-tours-list .tour-list li,
body.dark #saved-tours-list .tour-list li {
    background: rgba(255,255,255,0.06);
    color: #d6e1f0;
}
#planned-tours-list,
#saved-tours-list {
    display: none;
}
#planned-tours-list .tour-nr,
#saved-tours-list .tour-nr {
    text-align: right;
    opacity: 0.7;
    font-variant-numeric: tabular-nums;
}

#saved-tours-list .tour-date {
    white-space: nowrap;
    font-variant-numeric: tabular-nums;
}
#planned-tours-list .tour-name,
#saved-tours-list .tour-name {
    font-weight: 500;
}

#planned-table tbody tr.highlight,
#overview-table tbody tr.highlight {
    animation: rowHighlight 2s ease-out;
}

@keyframes rowHighlight {
    0% {
        background-color: rgba(122, 13, 13, 0.8);
    }
    100% {
        background-color: transparent;
    }
}

@media (max-width: 768px) {
    #planned-tours-list,
    #saved-tours-list {
        display: block;
    }
}

.season-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 10px;
}

.season-grid select {
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.3);
  background: rgba(255,255,255,0.25);
  font-size: 0.95rem;
}

body.dark .season-grid select {
  background: rgba(255,255,255,0.08);
  color: #d6e1f0;
}

.footer-logo-wrapper {
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
    margin-top: 60px;
    margin-bottom: 20px;
    pointer-events: none;
}

/* Logos √ºbereinander legen */
.footer-logo {
    width: 220px;
    max-width: 70vw;
    position: absolute;
    transition: opacity 0.5s ease-in-out;
}

/* Lightmode sichtbar */
.light-logo {
    opacity: 1;
    z-index: 2;
}

/* Darkmode versteckt */
.dark-logo {
    opacity: 0;
    z-index: 3;
}

/* Wenn Darkmode aktiv */
body.dark .light-logo {
    opacity: 0;
}

body.dark .dark-logo {
    opacity: 1;
}

</style>
</head>
<body>


<div class="sun"></div>
<div class="parallax">
    <div class="layer layer1"></div>
    <div class="layer layer2"></div>
    <div class="layer layer3"></div>
</div>
<div class="cloud cloud-layer1" style="left:-250px;"></div>
<div class="cloud cloud-layer1" style="left:-600px;"></div>
<div class="cloud cloud-layer2" style="left:-400px;"></div>
<div class="cloud cloud-layer2" style="left:-800px;"></div>
<div class="cloud cloud-layer3" style="left:-500px;"></div>

<div class="app-wrapper">

    <div class="accordion-header">
        <h1 class="app-title">Tourentracker</h1>

    <div class="header-actions">
      <button id="diagram-toggle" class="toggle-btn" aria-label="Diagramm anzeigen">üìä</button>
      <button id="tour-toggle" class="toggle-btn" aria-label="Planung anzeigen">üß≠</button>
      <button id="theme-toggle" class="toggle-btn" aria-label="Dark Mode">üåô</button>
    </div>
    </div>



  <div class="view-container">

   <div id="app-view" class="view visible">
    <div class="accordion">



<!-- Box 1 -->
<div class="box">
    <div class="box-header"><span>Tour speichern</span><div class="arrow"></div></div>
    <div class="box-content">
        <form class="tour-form" id="tour-form">
            <div class="form-group"><label for="date">Datum:</label><input type="date" id="date" name="date"></div>
            <div class="form-group"><label for="tourname">Tourname:</label><input type="text" id="tourname" name="tourname"></div>
            <div class="form-group">
                <label for="gipfel">Gipfel:</label>
                <select id="gipfel" name="gipfel">
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                </select>
            </div>
            <!-- Dynamischer Gipfelbereich -->
            <div id="gipfel-details-container" style="display:none; flex-direction:column; gap:8px; margin-top:8px;"></div>

            <div class="form-group"><label for="strecke">Strecke (km):</label><input type="number" inputmode="decimal" step="0,1" min="0" id="strecke" name="strecke"></div>
            <div class="form-group"><label for="aufstieg">Aufstieg (Hm):</label><input type="number" inputmode="numeric" step="1" min="0" id="aufstieg" name="aufstieg"></div>
            <div class="form-group"><label for="ausgangspunkt">Ausgangspunkt:</label><input type="text" id="ausgangspunkt" name="ausgangspunkt"></div>
            <div class="form-group"><label for="zeit">Gehzeit (hh:mm):</label><input type="text" inputmode="numeric" maxlength="5" id="zeit" name="zeit"></div>
            <button type="button" class="save-btn" id="save-btn">Speichern</button>
        </form>
    </div>
</div>

    <!-- Statistikfilter -->
    <div class="stats-filters">
        <select id="filter-year">
            <option value="all">Alle Jahre</option>
        </select>
        <select id="filter-month">
            <option value="all">Alle Monate</option>
        </select>
<label for="filter-has-peak"
       class="has-peak-label"
       style="display:flex; align-items:center; gap:4px;">
    <input type="checkbox" id="filter-has-peak">
    Gipfeltouren
</label>
    </div>

<!-- Box 2: Alle Touren kompakt -->
<div class="box" id="saved-tours-list">
  <div class="box-header">
    <span>Tourenliste</span>
    <div class="arrow"></div>
  </div>
  <div class="box-content">

    <ul class="tour-list">

    </ul>
  </div>
</div>

<!-- Box 3 Tabelle -->
<div class="box">
    <div class="box-header"><span>Alle Touren</span><div class="arrow"></div></div>
    <div class="box-content">
        <div id="overview-table-wrapper">
            <table id="overview-table">
                <thead>
                    <tr>
                        <th>Nr.</th>
                        <th>Datum</th>
                        <th>Tourname</th>
                        <th>Gipfel</th>
                        <th>Strecke</th>
                        <th>Aufstieg</th>
                        <th>Startpunkt</th>
                        <th>Gehzeit</th>
                        <th>Aktion</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Box 4 Statistik -->
<div class="box">
    <div class="box-header"><span>Statistik</span><div class="arrow"></div></div>
    <div class="box-content" id="stats-box">
    <p>Anzahl Touren: <span id="total-tours">0</span></p>
    <p>Gipfel erreicht: <span id="total-peaks">0</span></p>
    <p>Gesamte Strecke (km): <span id="total-distance">0</span></p>
    <p>Gesamter Aufstieg (Hm): <span id="total-ascent">0</span></p>
    <p>Gesamte Gehzeit (Std.): <span id="total-time">0:00</span></p>
    <p>√ò Geschwindigkeit (km/h): <span id="avg-speed">0</span></p>
    <p>√ò Steigung (hm/km): <span id="avg-gradient">0</span></p>
</div>

</div>

<!-- Box 5: Gefilterte Gipfel -->
<div class="box" id="peaks-box">
    <div class="box-header"><span>Gipfelliste</span><div class="arrow"></div></div>
    <div class="box-content">
        <div id="filtered-peaks-container" style="display:flex; flex-direction:column; gap:6px;"></div>
    </div>
</div>

<!-- Box 6: Highlights -->
<div class="box" id="highlights-box">
    <div class="box-header">
        <span>Highlights</span>
        <div class="arrow"></div>
    </div>
    <div class="box-content">
        <p class="highlight-row">
            <span class="highlight-label">L√§ngste Strecke (km):</span>
            <span class="highlight-value" id="longest-tour">‚Äì</span>
        </p>
        <p class="highlight-row">
            <span class="highlight-label">Gr√∂√üter Aufstieg (Hm):</span>
            <span class="highlight-value" id="biggest-ascent-tour">‚Äì</span>
        </p>
        <p class="highlight-row">
            <span class="highlight-label">L√§ngste Tour (Std.):</span>
            <span class="highlight-value" id="longest-time-tour">‚Äì</span>
        </p>
        <p class="highlight-row">
            <span class="highlight-label">H√∂chster Gipfel:</span>
            <span class="highlight-value" id="highest-peak">‚Äì</span>
        </p>
<p class="highlight-row">
    <span class="highlight-label">Schnellste Tour (km/h):</span>
    <span class="highlight-value" id="fastestTour">‚Äì</span>
</p>
<p class="highlight-row">
    <span class="highlight-label">Steilste Tour (Hm/km):</span>
    <span class="highlight-value" id="steepestTour">‚Äì</span>
</p>
    </div>
</div>

       </div>
    </div>

    <!-- üìä Diagramm-View -->
<div id="chart-view" class="view" style="flex-direction:column; align-items:center; width:100%;">
    <canvas id="tours-canvas" style="width:100%; height:300px; margin-bottom:30px; background:rgba(0,255,0,0.05);"></canvas>
    <canvas id="distance-canvas" style="width:100%; height:300px; margin-bottom:30px; background:rgba(0,255,0,0.05);"></canvas>
    <canvas id="diagram-canvas" style="width:100%; height:300px; margin-bottom:30px; background:rgba(0,255,0,0.05);"></canvas>
    <canvas id="time-canvas" style="width:100%; height:300px; margin-bottom:30px; background:rgba(0,255,0,0.05);"></canvas>
    <canvas id="peaks-canvas" style="width:100%; height:300px; margin-bottom:30px; background:rgba(0,255,0,0.05);"></canvas>
    <canvas id="speed-canvas" style="width:100%; height:300px; margin-bottom:30px; background:rgba(0,255,0,0.05);"></canvas>
    <canvas id="gradient-canvas" style="width:100%; height:300px; margin-bottom:30px; background:rgba(0,255,0,0.05);"></canvas>
</div>

<div id="tour-view" class="view">

  <div class="accordion">

<div class="box">
    <div class="box-header">
        <span>Tour planen</span>
        <div class="arrow"></div>
    </div>
    <div class="box-content">
        <form class="tour-form" id="plan-form">
            <div class="form-group">
                <label>Tourname:</label>
                <input type="text" id="plan-tourname">
            </div>

            <div class="form-group tour-season">
              <label>Beste Zeit</label>

              <div class="season-grid">
               <select id="monat-von">
                <option value="">Von</option>
               </select>

               <select id="monat-bis">
                <option value="">Bis</option>
               </select>

              </div>
            </div>

            <div class="form-group">
                <label>Gipfel:</label>
                <select id="plan-gipfel-count">
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                </select>
            </div>

            <div id="plan-gipfel-details"></div>

            <div class="form-group">
                <label>Strecke (km):</label>
                <input type="number" inputmode="decimal" step="0,1" min="0" id="plan-strecke">
            </div>

            <div class="form-group">
                <label>Aufstieg (Hm):</label>
                <input type="number" inputmode="numeric" step="1" min="0" id="plan-aufstieg">
            </div>

            <div class="form-group">
                <label>Ausgangspunkt:</label>
                <input type="text" id="plan-ausgangspunkt">
            </div>

            <div class="form-group">
                <label>Gehzeit:</label>
                <input type="text" inputmode="numeric" maxlength="5" id="plan-zeit" name="plan-zeit">
            </div>

            <button type="button" class="save-btn" id="plan-save-btn">Planen</button>
        </form>
    </div>
</div>

<!-- Box : Alle Touren kompakt -->
<div class="box" id="planned-tours-list">
  <div class="box-header">
    <span>Tourliste</span>
    <div class="arrow"></div>
  </div>
  <div class="box-content">

    <ul class="tour-list">

    </ul>
  </div>
</div>

<div class="box">
    <div class="box-header">
        <span>Geplante Touren</span>
        <div class="arrow"></div>
    </div>
    <div class="box-content">
        <div id="planned-table-wrapper">
            <table id="planned-table">
                <thead>
                    <tr>
                        <th>Nr.</th>
                        <th>Beste Zeit</th>
                        <th>Tourname</th>
                        <th>Gipfel</th>
                        <th>Strecke</th>
                        <th>Aufstieg</th>
                        <th>Startpunkt</th>
                        <th>Gehzeit</th>
                        <th>Aktion</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Box ‚Äì √úbersicht geplante Touren -->
<div class="box">
    <div class="box-header">
        <span>√úbersicht</span>
        <div class="arrow"></div>
    </div>
    <div class="box-content" id="overview-box">
        <p>Geplante Touren: <span id="ov-total-tours">0</span></p>
        <p>Gipfel gesamt: <span id="ov-total-peaks">0</span></p>
        <p>Gesamtstrecke (km): <span id="ov-total-distance">0</span></p>
        <p>Gesamtaufstieg (Hm): <span id="ov-total-ascent">0</span></p>
        <p>Gesamte Gehzeit (Std.): <span id="ov-total-time">0:00</span></p>
    </div>
</div>

  </div>

</div>

</div>


<script>


document.addEventListener('DOMContentLoaded', () => {
    const themeToggle = document.getElementById('theme-toggle');

    // gespeicherten Modus laden
    if(localStorage.getItem('theme') === 'dark'){
        document.body.classList.add('dark');
        themeToggle.textContent = '‚òÄÔ∏è';
    } else {
        themeToggle.textContent = 'üåô';
    }

    themeToggle.addEventListener('click', () => {
        const isDark = document.body.classList.toggle('dark');
        themeToggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        localStorage.setItem('theme', isDark ? 'dark' : 'light');

        // Diagramm neu zeichnen, falls sichtbar
        drawDistanceDiagram(); drawDiagram(); drawTimeDiagram(); drawPeaksDiagram(); drawSpeedDiagram(); drawGradientDiagram(); drawToursDiagram();
    });

    // Bestehende Touren
    loadData();

    // Geplante Touren
    loadPlannedTours();

    // Box-H√∂hen korrekt setzen, falls aktiv
    document.querySelectorAll('.box').forEach(box => {
        if(box.classList.contains('active')){
            const content = box.querySelector('.box-content');
            content.style.maxHeight = content.scrollHeight + 'px';
        }
    });

});


const zeitInput = document.getElementById('zeit');

zeitInput.addEventListener('input', (e) => {
    let v = e.target.value;

    // Alles au√üer Ziffern entfernen
    v = v.replace(/\D/g, '');

    // Maximal 4 Ziffern (hhmm)
    v = v.slice(0, 4);

    // Nach 2 Ziffern automatisch Doppelpunkt einf√ºgen
    if (v.length >= 3) {
        v = v.slice(0, 2) + ':' + v.slice(2);
    }

    e.target.value = v;
});

const planZeitInput = document.getElementById('plan-zeit');

planZeitInput.addEventListener('input', (e) => {
    let v = e.target.value;

    // Alles au√üer Ziffern entfernen
    v = v.replace(/\D/g, '');

    // Maximal 4 Ziffern (hhmm)
    v = v.slice(0, 4);

    // Nach 2 Ziffern automatisch Doppelpunkt einf√ºgen
    if (v.length >= 3) {
        v = v.slice(0, 2) + ':' + v.slice(2);
    }

    e.target.value = v;
});

// ---------------- Accordion ----------------
document.querySelectorAll('.box-header').forEach(header => {
    header.addEventListener('click', () => {
        const box = header.parentElement;
        const content = box.querySelector('.box-content');
        box.classList.toggle('active');
        if(box.classList.contains('active')){
            content.style.maxHeight = content.scrollHeight + "px";
        } else {
            content.style.maxHeight = "0";
        }
    });
});

// ---------------- Parallax ----------------
window.addEventListener('scroll', () => {
    const scroll = window.scrollY;
    document.querySelector('.layer1').style.transform = `translateX(${scroll*0.1}px)`;
    document.querySelector('.layer2').style.transform = `translateX(${scroll*0.05}px)`;
    document.querySelector('.layer3').style.transform = `translateX(${scroll*0.02}px)`;
});

// ---------------- Animate Value ----------------
function animateValue(element, start, end, duration = 1000, decimals = 0){
    const startTime = performance.now();

    const step = (currentTime) => {
        const progress = Math.min((currentTime - startTime) / duration, 1);
        const value = start + (end - start) * progress;

        element.textContent = Number(value)
            .toFixed(decimals)
            .replace('.',',');

        if(!element.classList.contains('stats-glow')){
            element.classList.add('stats-glow');
            setTimeout(()=>element.classList.remove('stats-glow'), duration);
        }

        if(progress < 1) requestAnimationFrame(step);
    };

    requestAnimationFrame(step);
}

// ---------------- Box Height ----------------
const statsBox = document.getElementById('stats-box');
const box2 = statsBox.closest('.box');
function updateStatsBoxHeight(){
    const content = box2.querySelector('.box-content');
    if(box2.classList.contains('active')){
        content.style.maxHeight = content.scrollHeight + 'px';
    }
}
function updateBoxHeight(box){
    const content = box.querySelector('.box-content');
    if(box.classList.contains('active')){
        content.style.maxHeight = content.scrollHeight + "px";
    }
}

// ------------ Hilfsfunktion ------------

/**
 * √ñffnet eine .box (falls noch zu) und f√ºhrt danach eine Aktion aus (z.B. scrollen).
 * @param {HTMLElement} box - Die .box, die ge√∂ffnet werden soll
 * @param {Function} callback - Funktion, die nach dem √ñffnen ausgef√ºhrt wird
 */
function openBoxIfNeeded(box, callback) {
    if (!box) {
        if (typeof callback === 'function') callback();
        return;
    }

    // Wenn die Box schon offen ist ‚Üí sofort Callback
    if (box.classList.contains('active')) {
        // Layout einmal durchlaufen lassen
        requestAnimationFrame(() => {
            if (typeof callback === 'function') callback();
        });
        return;
    }

    const content = box.querySelector('.box-content');
    box.classList.add('active');

    if (content) {
        // Erst maxHeight setzen, dann nach dem Layout-Update scrollen
        content.style.maxHeight = content.scrollHeight + 'px';

        // Ein requestAnimationFrame reicht meist, zur Sicherheit kleine Verz√∂gerung
        setTimeout(() => {
            if (typeof callback === 'function') callback();
        }, 800);
    } else {
        if (typeof callback === 'function') callback();
    }
}

// ---------------- Filter ----------------
const filterYear = document.getElementById('filter-year');
const filterMonth = document.getElementById('filter-month');
const filterHasPeak = document.getElementById('filter-has-peak');
function populateFilters(data){
    const years = new Set();
    data.forEach(entry => {
        if(entry.date) years.add(new Date(entry.date).getFullYear());
    });
    const sortedYears = Array.from(years).sort((a,b)=>b-a);

    filterYear.innerHTML = '<option value="all">Alle Jahre</option>';
    sortedYears.forEach(y=>{
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y;
        filterYear.appendChild(opt);
    });

    const monthNames = ['J√§nner','Februar','M√§rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
    filterMonth.innerHTML = '<option value="all">Alle Monate</option>';
    monthNames.forEach((m,i)=>{
        const opt = document.createElement('option');
        opt.value = i+1;
        opt.textContent = m;
        filterMonth.appendChild(opt);
    });
}

// ---------------- Elemente ----------------
const saveBtn = document.getElementById('save-btn');
const form = document.getElementById('tour-form');
const tableBody = document.querySelector('#overview-table tbody');
const totalToursEl = document.getElementById('total-tours');
const totalPeaksEl = document.getElementById('total-peaks');
const totalDistanceEl = document.getElementById('total-distance');
const totalAscentEl = document.getElementById('total-ascent');
const totalTimeEl = document.getElementById('total-time');
const gipfelSelect = document.getElementById('gipfel');
const gipfelDetailsContainer = document.getElementById('gipfel-details-container');
const peaksContainer = document.getElementById('filtered-peaks-container');
const tableBox = document.querySelectorAll('.box')[2];
const longestTourEl = document.getElementById('longest-tour');
const biggestAscentTourEl = document.getElementById('biggest-ascent-tour');
const longestTimeTourEl = document.getElementById('longest-time-tour');
const highestPeakEl = document.getElementById('highest-peak');
const fastestTourEl = document.getElementById('fastestTour');
const steepestTourEl = document.getElementById('steepestTour');
const chartDistanceEl = document.getElementById('chart-distance');
const chartAscentEl   = document.getElementById('chart-ascent');
const chartTimeEl     = document.getElementById('chart-time');
const chartPeaksEl    = document.getElementById('peaks-canvas');

let currentView = 'app';

console.log('chartDistanceEl:', chartDistanceEl);
console.log('chartAscentEl:', chartAscentEl);
console.log('chartTimeEl:', chartTimeEl);
console.log('chartPeaksEl:', chartPeaksEl);

// ---------------- Dynamischer Gipfelbereich ----------------
gipfelSelect.addEventListener('change', ()=>{
    const count = parseInt(gipfelSelect.value);
    gipfelDetailsContainer.innerHTML = '';
    const box = gipfelSelect.closest('.box');
    if(count > 0){
        gipfelDetailsContainer.style.display='flex';
        for(let i=1;i<=count;i++){
            const div = document.createElement('div');
            div.classList.add('form-group');
            div.innerHTML = `
                <label>Gipfel ${i} Name:</label>
                <input type="text" name="gipfel_name_${i}">
                <label>Gipfel ${i} Seeh√∂he (m):</label>
                <input type="number" inputmode="numeric" step="1" min="0" name="gipfel_hoehe_${i}">
            `;
            gipfelDetailsContainer.appendChild(div);
        }
    } else {
        gipfelDetailsContainer.style.display='none';
    }
    requestAnimationFrame(() => updateBoxHeight(box));
});

// ---------------- Gefilterte Daten ----------------
function getFilteredData(){
    let data = JSON.parse(localStorage.getItem('touren')) || [];
    const year = filterYear.value;
    const month = filterMonth.value;
    const hasPeak = filterHasPeak.checked;
    if(year !== 'all') data = data.filter(entry => new Date(entry.date).getFullYear() == year);
    if(month !== 'all') data = data.filter(entry => (new Date(entry.date).getMonth()+1) === Number(month));
    if (hasPeak) data = data.filter(entry => entry.gipfel && entry.gipfel > 0);
    return data;
}

// ---------------- Tabelle laden ----------------
function loadData() {
    const data = getFilteredData();
    data.sort((a, b) => new Date(a.date) - new Date(b.date));
    const tableBody = document.querySelector('#overview-table tbody');
    tableBody.innerHTML = '';

    const tableBox = document.querySelector('#overview-table-wrapper').closest('.box');

    data.forEach((entry, index) => {
        const row = document.createElement('tr');
        
        const key = [
            entry.date,
            entry.tourname,
            entry.strecke,
            entry.aufstieg,
            entry.zeit
        ].join('|');

        row.dataset.key = key;

        row.innerHTML = `
            <td data-label="Nr."><span class="value">${index + 1}</span></td>
            <td data-label="Datum"><span class="value">${entry.date}</span></td>
            <td data-label="Tour"><span class="value">${entry.tourname}</span></td>
            <td data-label="Gipfel" class="gipfel-count" style="cursor:pointer; font-weight:600;"><span class="value">${entry.gipfel}</span></td>
            <td data-label="Strecke"><span class="value">${entry.strecke}</span></td>
            <td data-label="Aufstieg"><span class="value">${entry.aufstieg}</span></td>
            <td data-label="Startpunkt"><span class="value">${entry.ausgangspunkt}</span></td>
            <td data-label="Zeit"><span class="value">${entry.zeit}</span></td>
            <td data-label="Aktion"><button class="delete-btn">‚úï</button></td>
        `;
        tableBody.appendChild(row);

        // Gipfel-Accordion
        if (entry.gipfelDetails && entry.gipfelDetails.length > 0) {
            const detailRow = document.createElement('tr');
            detailRow.innerHTML = `
                <td colspan="9">
                    <div class="gipfel-accordion">
                        ${entry.gipfelDetails.map(g => `‚õ∞ ${g.name} ‚Äì ${g.hoehe} m`).join('<br>')}
                    </div>
                </td>
            `;
            tableBody.appendChild(detailRow);
            const accordion = detailRow.querySelector('.gipfel-accordion');
            row.querySelector('.gipfel-count').addEventListener('click', () => {
                accordion.style.display = accordion.style.display === 'block' ? 'none' : 'block';
                requestAnimationFrame(() => updateBoxHeight(tableBox));
            });
        }

// Delete-Button
row.querySelector('.delete-btn').addEventListener('click', () => {
    const allData = JSON.parse(localStorage.getItem('touren')) || [];

    // Schl√ºssel dieser Zeile aus dem DOM lesen
    const key = row.dataset.key;

    // Den passenden Eintrag im LocalStorage anhand des Keys finden
    const originalIndex = allData.findIndex(e => {
        const entryKey = [
            e.date,
            e.tourname,
            e.strecke,
            e.aufstieg,
            e.zeit
        ].join('|');
        return entryKey === key;
    });

    if (originalIndex > -1) {
        allData.splice(originalIndex, 1);
        localStorage.setItem('touren', JSON.stringify(allData));
        loadData(); // Tabelle & mobile Liste neu laden
    }
});

    });

    // Stats, Highlights etc.
    updateStats();
    updateFilteredPeaks();
    updateHighlights();
    updateCharts();

    // Tabellen-Box anpassen, falls offen
    if (tableBox && tableBox.classList.contains('active')) {
        requestAnimationFrame(() => updateBoxHeight(tableBox));
    }

    // üîÑ Mobile Tourenliste synchronisieren
    syncMobileTourListFromTable();

    // üîí Optional: H√∂he der Tourenlisten-Box korrekt setzen
    const listBox = document.getElementById('saved-tours-list');
    if (listBox) {
        const content = listBox.querySelector('.box-content');
        if (!content) return;

        if (listBox.classList.contains('active')) {
            requestAnimationFrame(() => {
                content.style.maxHeight = content.scrollHeight + 'px';
            });
        } else {
            content.style.maxHeight = '0px';
        }
    }

}

// --------------- mobile Liste --------------

function syncMobileTourListFromTable() {
    const listBox = document.querySelector('#saved-tours-list');
    if (!listBox) return;

    const list = listBox.querySelector('.tour-list');
    const tableBox = document.querySelector('#overview-table-wrapper').closest('.box');
    const rows = document.querySelectorAll('#overview-table tbody tr');

    list.innerHTML = '';

    let visibleIndex = 0;

    rows.forEach(row => {
        // Detail- oder unsichtbare Zeilen √ºberspringen
        if (row.style.display === 'none') return;

        const cells = row.querySelectorAll('td');
        // Detail-Zeilen (Accordion) haben in deinem Setup nur 1 td
        if (cells.length < 3) return;

        const dateText      = cells[1].textContent.trim();
        const tourText      = cells[2].textContent.trim();
        const distanceText  = cells[4].textContent.trim();
        const ascentText    = cells[5].textContent.trim();
        const timeText      = cells[7].textContent.trim();

        // Schl√ºssel so bauen, wie in loadData()
        const key = [
            dateText,
            tourText,
            distanceText,
            ascentText,
            timeText
        ].join('|');

        visibleIndex++;

        const li = document.createElement('li');
        li.dataset.key = key; // gleichen Schl√ºssel wie die Tabellenzeile verwenden

        li.innerHTML = `
            <span class="tour-nr">${visibleIndex}.</span>
            <span class="tour-date">${dateText}</span>
            <span class="tour-name">${tourText}</span>
        `;
        list.appendChild(li);

        // Klick-Handler f√ºr den Listen-Eintrag
        li.addEventListener('click', () => {
            // 1. passende Tabellenzeile anhand des Keys finden
            const selector = `#overview-table tbody tr[data-key="${CSS.escape(key)}"]`;
            const targetRow = document.querySelector(selector);
            if (!targetRow) return;

            // 2. Box "Tourenliste" schlie√üen
            const listBoxContainer = listBox.closest('.box');
            if (listBoxContainer && listBoxContainer.classList.contains('active')) {
                listBoxContainer.classList.remove('active');
                const listContent = listBoxContainer.querySelector('.box-content');
                if (listContent) {
                    listContent.style.maxHeight = '0px';
                }
            }

            // 3. Box "Alle Touren" √∂ffnen (falls n√∂tig), DANN scrollen
            openBoxIfNeeded(tableBox, () => {
                targetRow.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });

                targetRow.classList.add('highlight');
                setTimeout(() => {
                    targetRow.classList.remove('highlight');
                }, 2100);

            });
        });
    });

    // Falls keine Touren vorhanden
    if (visibleIndex === 0) {
        list.innerHTML = '<li style="opacity:.6">Keine Touren</li>';
        return;
    }

    // Wenn Box "Alle Touren" schon offen ist: H√∂he anpassen
    if (tableBox && tableBox.classList.contains('active')) {
        const boxContent = tableBox.querySelector('.box-content');
        if (boxContent) {
            requestAnimationFrame(() => {
                boxContent.style.maxHeight = boxContent.scrollHeight + 'px';
            });
        }
    }
}


// ---------------- Statistik ----------------
function updateStats(){
    const data = getFilteredData();
    let totalDistance=0,totalAscent=0,totalMinutes=0,totalPeaks=0;

    data.forEach(entry=>{
        const dist = entry.strecke ? parseFloat(entry.strecke.replace(',','.'))||0 :0;
        const asc = entry.aufstieg ? parseFloat(entry.aufstieg.replace(',','.'))||0 :0;
        totalDistance += dist;
        totalAscent += asc;
        if(entry.zeit && entry.zeit.includes(':')){
            const [h,m] = entry.zeit.split(':').map(Number);
            totalMinutes += h*60+m;
        }
        totalPeaks += parseInt(entry.gipfel)||0;
    });

    // --- Abgeleitete Kennzahlen ---

    // Minuten ‚Üí Stunden
    const totalHours = totalMinutes / 60;

    // km/h
    const avgSpeed = totalHours > 0
        ? (totalDistance / totalHours)
        : 0;

    // hm/km
    const avgGradient = totalDistance > 0
        ? (totalAscent / totalDistance)
        : 0;

    animateValue(totalToursEl, parseInt(totalToursEl.textContent)||0, data.length);
    animateValue(totalPeaksEl, parseInt(totalPeaksEl.textContent)||0, totalPeaks);
    animateValue(totalDistanceEl, parseFloat(totalDistanceEl.textContent.replace(',','.'))||0, totalDistance,1000,true);
    animateValue(totalAscentEl, parseInt(totalAscentEl.textContent.replace(',','.'))||0, Math.round(totalAscent));

    const currentTimeText = totalTimeEl.textContent.split(':');
    const currentMinutes = parseInt(currentTimeText[0])*60 + parseInt(currentTimeText[1]);
    const targetMinutes = totalMinutes;
    let startTime = null;
    if(!totalTimeEl.classList.contains('stats-glow')){
        totalTimeEl.classList.add('stats-glow');
        setTimeout(()=>totalTimeEl.classList.remove('stats-glow'),1000);
    }

    function animateTime(timestamp){
        if(!startTime) startTime=timestamp;
        const progress = Math.min((timestamp-startTime)/1000,1);
        const minutes = Math.floor(currentMinutes + (targetMinutes-currentMinutes)*progress);
        const hours = Math.floor(minutes/60);
        const mins = minutes%60;
        totalTimeEl.textContent = `${hours}:${mins.toString().padStart(2,'0')}`;
        if(progress<1) requestAnimationFrame(animateTime);
    }

const avgSpeedEl = document.getElementById('avg-speed');
const avgGradientEl = document.getElementById('avg-gradient');

animateValue(
    avgSpeedEl,
    parseFloat(avgSpeedEl.textContent.replace(',','.')) || 0,
    avgSpeed,
    1000,
    2
);

animateValue(
    avgGradientEl,
    parseFloat(avgGradientEl.textContent.replace(',','.')) || 0,
    avgGradient,
    1000,
    0
);

    requestAnimationFrame(animateTime);
    requestAnimationFrame(updateStatsBoxHeight);
}

// ---------------- Gipfelliste ----------------
function updateFilteredPeaks(){
    const data = getFilteredData();
    peaksContainer.innerHTML='';
    let allPeaks = [];
    data.forEach(entry=>{
        if(entry.gipfelDetails && entry.gipfelDetails.length>0){
            entry.gipfelDetails.forEach(g=>{
                if(g.name || g.hoehe) allPeaks.push(`${g.name} ‚Äì ${g.hoehe} m`);
            });
        }
    });
    if(allPeaks.length===0){
        peaksContainer.innerHTML='<em>Keine Gipfel erreicht</em>';
        return;
    }
    allPeaks.forEach((peak,i)=>{
        const div = document.createElement('div');
        div.textContent = `${i+1}. ${peak}`;
        peaksContainer.appendChild(div);
    });
    const box = document.getElementById('peaks-box');
    if(box.classList.contains('active')){
        const content = box.querySelector('.box-content');
        content.style.maxHeight = content.scrollHeight+'px';
    }
}

// ---------------- Highlights (Box 5) ----------------

function updateHighlights() {
    const data = getFilteredData();

    // Falls keine Daten nach Filter vorhanden sind
    if (!data || data.length === 0) {
        const msg = 'Fauler L√ºmmel';

        longestTourEl.textContent        = msg;
        biggestAscentTourEl.textContent  = msg;
        longestTimeTourEl.textContent    = msg;
        highestPeakEl.textContent        = msg;
        fastestTourEl.textContent        = msg;
        steepestTourEl.textContent       = msg;

        return;
    }

    let longestTour = null;          // nach Strecke
    let biggestAscentTour = null;    // nach Aufstieg
    let longestTimeTour = null;      // nach Zeit (Minuten)
    let highestPeak = null;          // { name, hoehe, tourname, date }
    let fastestTour = null;          // nach km/h
    let steepestTour = null;         // nach Hm/km

    data.forEach(entry => {
        const tourname = entry.tourname || '(ohne Namen)';
        const date = entry.date || '';

        // ---------------- Strecke (l√§ngste Tour) ----------------
        const dist = entry.strecke ? parseFloat(String(entry.strecke).replace(',', '.')) : 0;
        if (!isNaN(dist)) {
            if (!longestTour || dist > longestTour.dist) {
                longestTour = { dist, tourname, date };
            }
        }

        // ---------------- Aufstieg (meiste Hm) ----------------
        const asc = entry.aufstieg ? parseFloat(String(entry.aufstieg).replace(',', '.')) : 0;
        if (!isNaN(asc)) {
            if (!biggestAscentTour || asc > biggestAscentTour.asc) {
                biggestAscentTour = { asc, tourname, date };
            }
        }

        // ---------------- Zeit (l√§ngste Gehzeit) ----------------
        let minutes = 0;
        if (entry.zeit && entry.zeit.includes(':')) {
            const [h, m] = entry.zeit.split(':').map(Number);
            if (!isNaN(h) && !isNaN(m)) {
                minutes = h * 60 + m;
            }
        }
        if (!longestTimeTour || minutes > longestTimeTour.minutes) {
            longestTimeTour = {
                minutes,
                zeit: entry.zeit || '0:00',
                tourname,
                date
            };
        }

        // ---------------- Schnellste Tour (km/h) ----------------
        // Strecke UND Zeit vorhanden ‚Üí Geschwindigkeit berechnen
        if (entry.strecke && entry.zeit && entry.zeit.includes(':')) {
            const distFast = parseFloat(String(entry.strecke).replace(',', '.'));
            const [hFast, mFast] = entry.zeit.split(':').map(Number);

            if (!isNaN(distFast) && distFast > 0 && !isNaN(hFast) && !isNaN(mFast)) {
                const timeHours = (hFast * 60 + mFast) / 60;
                if (timeHours > 0) {
                    const speed = distFast / timeHours; // km/h
                    if (!fastestTour || speed > fastestTour.speed) {
                        fastestTour = {
                            speed,
                            tourname,
                            date
                        };
                    }
                }
            }
        }

        // ---------------- Steilste Tour (Hm/km) ----------------
        if (entry.aufstieg && entry.strecke) {
            const ascSteep  = parseFloat(String(entry.aufstieg).replace(',', '.'));
            const distSteep = parseFloat(String(entry.strecke).replace(',', '.'));

            if (!isNaN(ascSteep) && !isNaN(distSteep) && distSteep > 0) {
                const steepness = ascSteep / distSteep; // Hm/km
                if (!steepestTour || steepness > steepestTour.steepness) {
                    steepestTour = {
                        steepness,
                        tourname,
                        date
                    };
                }
            }
        }

        // ---------------- H√∂chster Gipfel ----------------
        if (entry.gipfelDetails && entry.gipfelDetails.length > 0) {
            entry.gipfelDetails.forEach(g => {
                if (!g || (!g.name && !g.hoehe)) return;

                const hoeheNum = g.hoehe
                    ? parseFloat(String(g.hoehe).replace(',', '.'))
                    : 0;

                if (!isNaN(hoeheNum)) {
                    if (!highestPeak || hoeheNum > highestPeak.hoehe) {
                        highestPeak = {
                            name: g.name || '(ohne Namen)',
                            hoehe: hoeheNum,
                            tourname,
                            date
                        };
                    }
                }
            });
        }
    });

    // ---------------- Ausgaben zusammenbauen ----------------

    if (longestTour) {
        longestTourEl.textContent =
            `${longestTour.tourname} (${longestTour.dist.toFixed(1).toString().replace('.', ',')} km, ${longestTour.date})`;
    } else {
        longestTourEl.textContent = 'Fauler L√ºmmel';
    }

    if (biggestAscentTour) {
        biggestAscentTourEl.textContent =
            `${biggestAscentTour.tourname} (${Math.round(biggestAscentTour.asc)} Hm, ${biggestAscentTour.date})`;
    } else {
        biggestAscentTourEl.textContent = 'Fauler L√ºmmel';
    }

    if (longestTimeTour) {
        const h = Math.floor(longestTimeTour.minutes / 60);
        const m = longestTimeTour.minutes % 60;
        const timeStr = `${h}:${m.toString().padStart(2, '0')}`;
        longestTimeTourEl.textContent =
            `${longestTimeTour.tourname} (${timeStr}, ${longestTimeTour.date})`;
    } else {
        longestTimeTourEl.textContent = 'Fauler L√ºmmel';
    }

    if (highestPeak) {
        highestPeakEl.textContent =
            `${highestPeak.name} ‚Äì ${Math.round(highestPeak.hoehe)} m (${highestPeak.tourname}, ${highestPeak.date})`;
    } else {
        highestPeakEl.textContent = '-';
    }

    if (fastestTour) {
        fastestTourEl.textContent =
            `${fastestTour.tourname} (${fastestTour.speed.toFixed(1).replace('.',',')} km/h, ${fastestTour.date})`;
    } else {
        fastestTourEl.textContent = 'Fauler L√ºmmel';
    }

    if (steepestTour) {
        steepestTourEl.textContent =
            `${steepestTour.tourname} (${steepestTour.steepness.toFixed(0)} Hm/km, ${steepestTour.date})`;
    } else {
        steepestTourEl.textContent = 'Fauler L√ºmmel';
    }

    // H√∂he der Box 5 an Inhalt anpassen, falls ge√∂ffnet
    const box = document.getElementById('highlights-box');
    if (box && box.classList.contains('active')) {
        const content = box.querySelector('.box-content');
        requestAnimationFrame(() => {
            content.style.maxHeight = content.scrollHeight + 'px';
        });
    }
}

// ---------------- Diagramme -----------------

function getYearlyMonthlyAggregates() {
    const allData = JSON.parse(localStorage.getItem('touren')) || [];
    const year = filterYear.value;

    const distance = Array(12).fill(0); // km
    const ascent   = Array(12).fill(0); // Hm
    const timeMin  = Array(12).fill(0); // Minuten
    const peaks    = Array(12).fill(0); // Gipfel

    allData.forEach(entry => {
        if (!entry.date) return;
        const d = new Date(entry.date);
        if (isNaN(d.getTime())) return;       // ung√ºltiges Datum

        // Wenn ein konkretes Jahr gew√§hlt wurde, nur dieses Jahr z√§hlen;
        // wenn "all", dann ALLE Jahre zusammenfassen
        if (year !== 'all' && d.getFullYear() !== Number(year)) return;

        const monthIndex = d.getMonth();      // 0..11

        // Strecke
        const dist = entry.strecke ? parseFloat(String(entry.strecke).replace(',', '.')) : 0;
        if (!isNaN(dist)) distance[monthIndex] += dist;

        // Aufstieg
        const asc = entry.aufstieg ? parseFloat(String(entry.aufstieg).replace(',', '.')) : 0;
        if (!isNaN(asc)) ascent[monthIndex] += asc;

        // Zeit
        if (entry.zeit && entry.zeit.includes(':')) {
            const [h, m] = entry.zeit.split(':').map(Number);
            if (!isNaN(h) && !isNaN(m)) {
                timeMin[monthIndex] += h * 60 + m;
            }
        }

        // Gipfel
        if (entry.gipfel) peaks[monthIndex] += parseInt(entry.gipfel) || 0; // NEU
    });

    const timeH = timeMin.map(m => m / 60);
    return { distance, ascent, timeH, peaks };
}

function renderBarChart(containerEl, values) {
    if (!containerEl) return;

    const max = Math.max(...values, 0);
    const safeMax = max <= 0 ? 1 : max; // Division durch 0 verhindern

    // Container leeren
    containerEl.innerHTML = '';

    values.forEach(v => {
        const bar = document.createElement('div');
        bar.classList.add('chart-bar');

        const ratio = v / safeMax;
        bar.style.transform = `scaleY(${ratio.toFixed(3)})`;

        containerEl.appendChild(bar);
    });
}

function updateCharts() {
    const { distance, ascent, timeH, peaks } = getYearlyMonthlyAggregates();

    renderBarChart(chartDistanceEl, distance);
    renderBarChart(chartAscentEl,   ascent);
    renderBarChart(chartTimeEl,     timeH);
    renderBarChart(chartPeaksEl,    peaks);

    // H√∂he der Box 6 aktualisieren, falls offen
    const chartsBox = document.getElementById('charts-box');
    if (chartsBox && chartsBox.classList.contains('active')) {
        const content = chartsBox.querySelector('.box-content');
        requestAnimationFrame(() => {
            content.style.maxHeight = content.scrollHeight + 'px';
        });
    }
}

// ---------------- Save-Button ----------------
saveBtn.addEventListener('click', ()=>{
    // Daten erfassen und speichern
    const datum = form.date.value.trim();
    const tourname = form.tourname.value.trim();
    const gipfel = parseInt(gipfelSelect.value);
    const strecke = form.strecke.value.trim();
    const aufstieg = form.aufstieg.value.trim();
    const ausgangspunkt = form.ausgangspunkt.value.trim();
    const zeit = form.zeit.value.trim();

    if(!datum){ alert('Datum muss ausgef√ºllt sein!'); return; }

    const numberRegex = /^\d+([.,]\d+)?$/;
    if(strecke && !numberRegex.test(strecke)){ alert('Strecke muss eine Zahl mit optionalem Komma sein.'); return; }
    if(aufstieg && !numberRegex.test(aufstieg)){ alert('Aufstieg muss eine ganze Zahl sein.'); return; }

    const timeRegex = /^\d+:[0-5][0-9]$/;
    if(zeit && !timeRegex.test(zeit)){ alert('Bewegungszeit muss im Format h:mm oder hh:mm sein.'); return; }

    // Gipfel-Details erfassen
    let gipfelDetails = [];
    if(gipfel > 0){
        for(let i=1;i<=gipfel;i++){
            const name = form[`gipfel_name_${i}`].value.trim();
            const hoehe = form[`gipfel_hoehe_${i}`].value.trim();
            if(name || hoehe){
                gipfelDetails.push({ name, hoehe });
            }
        }
    }

    const entry = { date: datum, tourname, gipfel, strecke, aufstieg, ausgangspunkt, zeit, gipfelDetails };
    const data = JSON.parse(localStorage.getItem('touren')) || [];
    data.push(entry);
    localStorage.setItem('touren', JSON.stringify(data));

    // Tabelle aktualisieren
    loadData();

    // Formular zur√ºcksetzen
    form.reset();
    gipfelDetailsContainer.style.display='none';

    // ‚úÖ Box 1 automatisch einklappen
    const box1 = document.querySelector('.box'); // erste Box = Box 1
    box1.classList.remove('active');
    const content1 = box1.querySelector('.box-content');
    content1.style.maxHeight = '0';
});

// ---------------- Filter Events ----------------
filterYear.addEventListener('change', loadData);
filterMonth.addEventListener('change', loadData);
filterHasPeak.addEventListener('change', loadData);

const toggleBtn = document.getElementById('theme-toggle');

// gespeicherten Modus laden
if(localStorage.getItem('theme') === 'dark'){
    document.body.classList.add('dark');
    toggleBtn.textContent = '‚òÄÔ∏è';
}

toggleBtn.addEventListener('click', ()=>{
    document.body.classList.toggle('dark');
    const dark = document.body.classList.contains('dark');
    toggleBtn.textContent = dark ? '‚òÄÔ∏è' : 'üåô';
    localStorage.setItem('theme', dark ? 'dark' : 'light');
});

// -------------- Canvas initialisieren ------

function prepareCanvas() {
    const canvas = document.getElementById('diagram-canvas');

    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();

    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;

    const ctx = canvas.getContext('2d');
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

    return ctx;
}

// --------------- Toggle-Logik --------------
const diagramToggle = document.getElementById('diagram-toggle');
const tourToggle = document.getElementById('tour-toggle');
const appView = document.getElementById('app-view');
const chartView = document.getElementById('chart-view');
const tourView = document.getElementById('tour-view');

let chartVisible = false;

diagramToggle.addEventListener('click', () => {

  // Icons zur√ºcksetzen
  diagramToggle.textContent = 'üìä';
  tourToggle.textContent = 'üß≠';

  // Views ausblenden
  appView.classList.remove('visible');
  chartView.classList.remove('visible');
  tourView.classList.remove('visible');

  if (currentView !== 'chart') {
    // Diagramm √∂ffnen
    chartView.classList.add('visible');
    diagramToggle.textContent = 'üìã';
    currentView = 'chart';

        // Diagramme NACH Sichtbarkeit neu zeichnen
        requestAnimationFrame(() => {
            drawDistanceDiagram();
            drawDiagram();
            drawTimeDiagram();
            drawPeaksDiagram();
            drawSpeedDiagram();
            drawGradientDiagram();
            drawToursDiagram();
        });
  } else {
    // zur√ºck zum Start
    appView.classList.add('visible');
    currentView = 'app';
  }
});

tourToggle.addEventListener('click', () => {

  // Icons zur√ºcksetzen
  diagramToggle.textContent = 'üìä';
  tourToggle.textContent = 'üß≠';

  // Views ausblenden
  appView.classList.remove('visible');
  chartView.classList.remove('visible');
  tourView.classList.remove('visible');

  if (currentView !== 'tour') {
    // Tourplanung √∂ffnen
    tourView.classList.add('visible');
    tourToggle.textContent = 'üìã';
    currentView = 'tour';
  } else {
    // zur√ºck zum Start
    appView.classList.add('visible');
    currentView = 'app';
  }
});

// ---------------- Diagramm Zeichnen -----------------
const distanceCanvas = document.getElementById('distance-canvas');
const diagramCanvas = document.getElementById('diagram-canvas');
const timeCanvas = document.getElementById('time-canvas');
const peaksCanvas = document.getElementById('peaks-canvas');
const ctx = diagramCanvas.getContext('2d');
const speedCanvas = document.getElementById('speed-canvas');
const gradientCanvas = document.getElementById('gradient-canvas');
const toursCanvas = document.getElementById('tours-canvas');

function drawDistanceDiagram() {
    const ctx = distanceCanvas.getContext('2d');
    distanceCanvas.width = distanceCanvas.clientWidth;
    distanceCanvas.height = distanceCanvas.clientHeight;
    ctx.clearRect(0,0,distanceCanvas.width,distanceCanvas.height);

    // √úberschrift
    ctx.fillStyle = document.body.classList.contains('dark') ? '#d6e1f0' : '#2e4036';
    ctx.font = getFontForCanvas(18);
    ctx.textAlign = 'center';
    ctx.fillText('Strecke (km)', distanceCanvas.width/2, 25);

    // Aggregierte Werte
    const selectedYear = filterYear.value;
    const allData = JSON.parse(localStorage.getItem('touren')) || [];
    const monthSums = Array(12).fill(0);

    allData.forEach(entry => {
        if(entry.strecke && entry.date){
            const date = new Date(entry.date);
            const year = date.getFullYear();
            if(selectedYear !== 'all' && year !== Number(selectedYear)) return;

            const month = date.getMonth();
            const value = parseFloat(entry.strecke.toString().replace(',', '.')) || 0;
            monthSums[month] += value;
        }
    });

    const paddingTop = 10;
    const padding = 40;
    const width = distanceCanvas.width - padding*2;
    const height = distanceCanvas.height - padding - paddingTop;
    const barWidth = width/12 - 10;
    const maxValue = Math.max(...monthSums, 1);
    const maxPeakRatio = 0.5; // max. zus√§tzliche H√∂he √ºber Bar
const maxBarHeight = height * (1 - maxPeakRatio);

    const barColor = document.body.classList.contains('dark') ? '#7a0d0d' : '#f9d77e';
    const textColor = document.body.classList.contains('dark') ? '#d6e1f0' : '#000000';

    monthSums.forEach((value,i)=>{
            const intensity = value / maxValue;
        const x = padding + i*(barWidth+10);
        const barHeight = (value / maxValue) * maxBarHeight;
        const y = distanceCanvas.height - padding - barHeight;

let gradient = ctx.createLinearGradient(
    x,
    y + barHeight,  // unten
    x,
    y               // oben
);

if(document.body.classList.contains('dark')){

    // Schwarz ‚Üí Rot
    gradient.addColorStop(0, '#000000');
    gradient.addColorStop(0.2, '#3b0000');
    gradient.addColorStop(1, '#7a0d0d');

}else{

    // Gr√ºn ‚Üí Gelb
    gradient.addColorStop(0, '#6fbf73');
    gradient.addColorStop(0.4, '#a8d86a');
    gradient.addColorStop(1, '#f9d77e');
}

ctx.fillStyle = gradient;
drawMountainBar(ctx, x, y, barWidth, barHeight, i, intensity);
ctx.fill();

ctx.strokeStyle = 'rgba(255,255,255,0.15)';
ctx.lineWidth = 1;
ctx.stroke();

// Gloss-Highlight (nur oberer Teil)
const glossHeight = barHeight;

let gloss = ctx.createLinearGradient(
    x,
    y,
    x,
    y + glossHeight
);

gloss.addColorStop(0, 'rgba(255,255,255,0.35)');
gloss.addColorStop(1, 'rgba(255,255,255,0)');

ctx.fillStyle = gloss;
drawMountainBar(ctx, x, y, barWidth, glossHeight, i, intensity);
ctx.fill();



// Hochkant Wert nur wenn >0
if (value > 0) {
    ctx.save();
    ctx.translate(x + barWidth/2, y + barHeight/2);
    ctx.rotate(-Math.PI/2);
    ctx.fillStyle = textColor;
    ctx.font = getFontForCanvas(12);
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(value.toFixed(1), 0, 0);
    ctx.restore();
}

        // Monatsname
        ctx.fillStyle = textColor;
        ctx.font = getFontForCanvas(12);
        ctx.textAlign = 'center';
        ctx.fillText(['J','F','M','A','M','J','J','A','S','O','N','D'][i], x + barWidth/2, distanceCanvas.height - padding + 14);
    });

    // Linie unten
    ctx.strokeStyle = document.body.classList.contains('dark') ? '#d6e1f030' : '#2e403630';
    ctx.beginPath();
    ctx.moveTo(padding,distanceCanvas.height - padding);
    ctx.lineTo(distanceCanvas.width - padding,distanceCanvas.height - padding);
    ctx.stroke();
}

function drawDiagram() {
    // Canvas sauber machen
    diagramCanvas.width = diagramCanvas.clientWidth;
    diagramCanvas.height = diagramCanvas.clientHeight;
    ctx.clearRect(0, 0, diagramCanvas.width, diagramCanvas.height);

    // √úberschrift
    ctx.fillStyle = document.body.classList.contains('dark') ? '#d6e1f0' : '#2e4036';
    ctx.font = getFontForCanvas(18);
    ctx.textAlign = 'center';
    ctx.fillText('Aufstieg (hm)', diagramCanvas.width / 2, 25);

    // Ausgew√§hltes Jahr aus Filter
    const selectedYear = filterYear.value;

    // Aggregierte Daten pro Monat
    const allData = JSON.parse(localStorage.getItem('touren')) || [];
    const monthSums = Array(12).fill(0);

    allData.forEach(entry => {
        if(entry.aufstieg && entry.date) {
            const date = new Date(entry.date);
            const year = date.getFullYear();
            if(selectedYear !== 'all' && year !== Number(selectedYear)) return;

            const month = date.getMonth(); // 0..11
            const value = parseFloat(entry.aufstieg.toString().replace(',', '.')) || 0;
            monthSums[month] += value;
        }
    });

    // Layout
    const paddingTop = 10;  
    const padding = 40;
    const width = diagramCanvas.width - padding * 2;
    const height = diagramCanvas.height - padding - paddingTop;
    const barWidth = width / 12 - 10;
    const maxValue = Math.max(...monthSums, 100); 
    const maxPeakRatio = 0.5; // max. zus√§tzliche H√∂he √ºber Bar
const maxBarHeight = height * (1 - maxPeakRatio);

    // Farben
    const barColor = document.body.classList.contains('dark') ? '#7a0d0d' : '#f9d77e';
    const textColor = document.body.classList.contains('dark') ? '#d6e1f0' : '#2e4036';

    monthSums.forEach((value, i) => {
            const intensity = value / maxValue;
        const x = padding + i * (barWidth + 10);
        const barHeight = (value / maxValue) * maxBarHeight;
        const y = diagramCanvas.height - padding - barHeight;

let gradient = ctx.createLinearGradient(
    x,
    y + barHeight,  // unten
    x,
    y               // oben
);

if(document.body.classList.contains('dark')){

    // Schwarz ‚Üí Rot
    gradient.addColorStop(0, '#000000');
    gradient.addColorStop(0.2, '#3b0000');
    gradient.addColorStop(1, '#7a0d0d');

}else{

    // Gr√ºn ‚Üí Gelb
    gradient.addColorStop(0, '#6fbf73');
    gradient.addColorStop(0.4, '#a8d86a');
    gradient.addColorStop(1, '#f9d77e');
}

ctx.fillStyle = gradient;
drawMountainBar(ctx, x, y, barWidth, barHeight, i, intensity);
ctx.fill();

ctx.strokeStyle = 'rgba(255,255,255,0.15)';
ctx.lineWidth = 1;
ctx.stroke();

// Gloss-Highlight (nur oberer Teil)
const glossHeight = barHeight;

let gloss = ctx.createLinearGradient(
    x,
    y,
    x,
    y + glossHeight
);

gloss.addColorStop(0, 'rgba(255,255,255,0.35)');
gloss.addColorStop(1, 'rgba(255,255,255,0)');

ctx.fillStyle = gloss;
drawMountainBar(ctx, x, y, barWidth, glossHeight, i, intensity);
ctx.fill();


    // Hochkant Wert NUR wenn >0
    if (value > 0) {
        ctx.save();
        ctx.translate(x + barWidth / 2, y + barHeight / 2);
        ctx.rotate(-Math.PI / 2);
        ctx.fillStyle = textColor;
        ctx.font = getFontForCanvas(12);
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(Math.round(value), 0, 0);
        ctx.restore();
    }

        // Monatsname unten
        ctx.fillStyle = textColor;
        ctx.font = getFontForCanvas(12);
        ctx.textAlign = 'center';
        ctx.fillText(['J','F','M','A','M','J','J','A','S','O','N','D'][i], x + barWidth / 2, diagramCanvas.height - padding + 14);
    });

    // Horizontale Linie unten
    ctx.strokeStyle = document.body.classList.contains('dark') ? '#d6e1f030' : '#2e403630';
    ctx.beginPath();
    ctx.moveTo(padding, diagramCanvas.height - padding);
    ctx.lineTo(diagramCanvas.width - padding, diagramCanvas.height - padding);
    ctx.stroke();
}

function drawTimeDiagram() {
    const ctx = timeCanvas.getContext('2d');
    timeCanvas.width = timeCanvas.clientWidth;
    timeCanvas.height = timeCanvas.clientHeight;
    ctx.clearRect(0,0,timeCanvas.width,timeCanvas.height);

    // √úberschrift
    ctx.fillStyle = document.body.classList.contains('dark') ? '#d6e1f0' : '#2e4036';
    ctx.font = getFontForCanvas(18);
    ctx.textAlign = 'center';
    ctx.fillText('Gehzeit (h)', timeCanvas.width/2, 25);

    // Aggregierte Werte
    const selectedYear = filterYear.value;
    const allData = JSON.parse(localStorage.getItem('touren')) || [];
    const monthSums = Array(12).fill(0);

    allData.forEach(entry => {
        if(entry.zeit && entry.date){
            const date = new Date(entry.date);
            const year = date.getFullYear();
            if(selectedYear !== 'all' && year !== Number(selectedYear)) return;

            const month = date.getMonth();
            // Gehzeit in Minuten umwandeln
            const [h,m] = entry.zeit.split(':').map(Number);
            if(!isNaN(h) && !isNaN(m)){
                monthSums[month] += h*60 + m;
            }
        }
    });

    const paddingTop = 10;
    const padding = 40;
    const width = timeCanvas.width - padding*2;
    const height = timeCanvas.height - padding - paddingTop;
    const barWidth = width/12 - 10;
    const maxValue = Math.max(...monthSums, 1);
    const maxPeakRatio = 0.5; // max. zus√§tzliche H√∂he √ºber Bar
const maxBarHeight = height * (1 - maxPeakRatio);

    const barColor = document.body.classList.contains('dark') ? '#7a0d0d' : '#f9d77e';
    const textColor = document.body.classList.contains('dark') ? '#d6e1f0' : '#2e4036';

    monthSums.forEach((value,i)=>{
            const intensity = value / maxValue;
        const x = padding + i*(barWidth+10);
        const barHeight = (value / maxValue) * maxBarHeight;
        const y = timeCanvas.height - padding - barHeight;

let gradient = ctx.createLinearGradient(
    x,
    y + barHeight,  // unten
    x,
    y               // oben
);

if(document.body.classList.contains('dark')){

    // Schwarz ‚Üí Rot
    gradient.addColorStop(0, '#000000');
    gradient.addColorStop(0.2, '#3b0000');
    gradient.addColorStop(1, '#7a0d0d');

}else{

    // Gr√ºn ‚Üí Gelb
    gradient.addColorStop(0, '#6fbf73');
    gradient.addColorStop(0.4, '#a8d86a');
    gradient.addColorStop(1, '#f9d77e');
}

ctx.fillStyle = gradient;
drawMountainBar(ctx, x, y, barWidth, barHeight, i, intensity);
ctx.fill();

ctx.strokeStyle = 'rgba(255,255,255,0.15)';
ctx.lineWidth = 1;
ctx.stroke();

// Gloss-Highlight (nur oberer Teil)
const glossHeight = barHeight;

let gloss = ctx.createLinearGradient(
    x,
    y,
    x,
    y + glossHeight
);

gloss.addColorStop(0, 'rgba(255,255,255,0.35)');
gloss.addColorStop(1, 'rgba(255,255,255,0)');

ctx.fillStyle = gloss;
drawMountainBar(ctx, x, y, barWidth, glossHeight, i, intensity);
ctx.fill();


// Hochkant Wert nur wenn >0
if (value > 0) {
    const hours = Math.floor(value / 60);
    const minutes = Math.round(value % 60);
    ctx.save();
    ctx.translate(x + barWidth/2, y + barHeight/2);
    ctx.rotate(-Math.PI/2);
    ctx.fillStyle = textColor;
    ctx.font = getFontForCanvas(12);
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(`${hours}:${minutes.toString().padStart(2,'0')} `, 0, 0);
    ctx.restore();
}

        // Monatsname
        ctx.fillStyle = textColor;
        ctx.font = getFontForCanvas(12);
        ctx.textAlign = 'center';
        ctx.fillText(['J','F','M','A','M','J','J','A','S','O','N','D'][i], x + barWidth/2, timeCanvas.height - padding + 14);
    });

    // Linie unten
    ctx.strokeStyle = document.body.classList.contains('dark') ? '#d6e1f030' : '#2e403630';
    ctx.beginPath();
    ctx.moveTo(padding,timeCanvas.height - padding);
    ctx.lineTo(timeCanvas.width - padding,timeCanvas.height - padding);
    ctx.stroke();
}

function drawPeaksDiagram() {
    const ctx = peaksCanvas.getContext('2d');
    peaksCanvas.width = peaksCanvas.clientWidth;
    peaksCanvas.height = peaksCanvas.clientHeight;
    ctx.clearRect(0, 0, peaksCanvas.width, peaksCanvas.height);

    // √úberschrift
    ctx.fillStyle = document.body.classList.contains('dark') ? '#d6e1f0' : '#2e4036';
    ctx.font = getFontForCanvas(18);
    ctx.textAlign = 'center';
    ctx.fillText('Erreichte Gipfel', peaksCanvas.width / 2, 25);

    const selectedYear = filterYear.value;
    const allData = JSON.parse(localStorage.getItem('touren')) || [];
    const monthSums = Array(12).fill(0);

    allData.forEach(entry => {
        if (!entry.date || !entry.gipfel) return;

        const d = new Date(entry.date);
        if (isNaN(d.getTime())) return;

        if (selectedYear !== 'all' && d.getFullYear() !== Number(selectedYear)) return;

        const monthIndex = d.getMonth();
        monthSums[monthIndex] += parseInt(entry.gipfel) || 0;
    });

    // Layout
    const paddingTop = 10;
    const padding = 40;
    const width = peaksCanvas.width - padding * 2;
    const height = peaksCanvas.height - padding - paddingTop;
    const barWidth = width / 12 - 10;
    const maxValue = Math.max(...monthSums, 1);

    const barColor = document.body.classList.contains('dark') ? '#7a0d0d' : '#f9d77e';
    const textColor = document.body.classList.contains('dark') ? '#d6e1f0' : '#2e4036';

    monthSums.forEach((value, i) => {
            const intensity = value / maxValue;
        const x = padding + i * (barWidth + 10);
        const barHeight = (value / maxValue) * height;
        const y = peaksCanvas.height - padding - barHeight;

let gradient = ctx.createLinearGradient(
    x,
    y + barHeight,  // unten
    x,
    y               // oben
);

if(document.body.classList.contains('dark')){

    // Schwarz ‚Üí Rot
    gradient.addColorStop(0, '#000000');
    gradient.addColorStop(0.2, '#3b0000');
    gradient.addColorStop(1, '#7a0d0d');

}else{

    // Gr√ºn ‚Üí Gelb
    gradient.addColorStop(0, '#6fbf73');
    gradient.addColorStop(0.4, '#a8d86a');
    gradient.addColorStop(1, '#f9d77e');
}

ctx.fillStyle = gradient;
drawMountainBar(ctx, x, y, barWidth, barHeight, i, intensity);
ctx.fill();

ctx.strokeStyle = 'rgba(255,255,255,0.15)';
ctx.lineWidth = 1;
ctx.stroke();

// Gloss-Highlight (nur oberer Teil)
const glossHeight = barHeight;

let gloss = ctx.createLinearGradient(
    x,
    y,
    x,
    y + glossHeight
);

gloss.addColorStop(0, 'rgba(255,255,255,0.35)');
gloss.addColorStop(1, 'rgba(255,255,255,0)');

ctx.fillStyle = gloss;
drawMountainBar(ctx, x, y, barWidth, glossHeight, i, intensity);
ctx.fill();


        if (value > 0) {
            ctx.save();
            ctx.translate(x + barWidth / 2, y + barHeight / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillStyle = textColor;
            ctx.font = getFontForCanvas(12);
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(value, 0, 0);
            ctx.restore();
        }

        ctx.fillStyle = textColor;
        ctx.font = getFontForCanvas(12);
        ctx.textAlign = 'center';
        ctx.fillText(['J','F','M','A','M','J','J','A','S','O','N','D'][i], x + barWidth / 2, peaksCanvas.height - padding + 14);
    });

    ctx.strokeStyle = document.body.classList.contains('dark') ? '#d6e1f030' : '#2e403630';
    ctx.beginPath();
    ctx.moveTo(padding, peaksCanvas.height - padding);
    ctx.lineTo(peaksCanvas.width - padding, peaksCanvas.height - padding);
    ctx.stroke();
}

function drawSpeedDiagram(){

    const ctx = speedCanvas.getContext('2d');
    speedCanvas.width = speedCanvas.clientWidth;
    speedCanvas.height = speedCanvas.clientHeight;
    ctx.clearRect(0,0,speedCanvas.width,speedCanvas.height);

    ctx.fillStyle = document.body.classList.contains('dark') ? '#d6e1f0' : '#2e4036';
    ctx.font = getFontForCanvas(18);
    ctx.textAlign = 'center';
    ctx.fillText('√ò Geschwindigkeit (km/h)', speedCanvas.width/2, 25);

    const selectedYear = filterYear.value;
    const allData = JSON.parse(localStorage.getItem('touren')) || [];

    const monthDist = Array(12).fill(0);
    const monthTime = Array(12).fill(0);

    allData.forEach(entry => {
        if(!entry.date) return;

        const d = new Date(entry.date);
        if(selectedYear !== 'all' && d.getFullYear() !== Number(selectedYear)) return;

        const m = d.getMonth();

        const dist = parseFloat(entry.strecke?.toString().replace(',','.')) || 0;
        monthDist[m] += dist;

        if(entry.zeit && entry.zeit.includes(':')){
            const [h,min] = entry.zeit.split(':').map(Number);
            monthTime[m] += h*60+min;
        }
    });

    const values = monthDist.map((d,i)=>{
        return monthTime[i] > 0 ? d / (monthTime[i]/60) : 0;
    });

    drawBars(speedCanvas, ctx, values, '', 2);
}

function drawGradientDiagram(){

    const ctx = gradientCanvas.getContext('2d');
    gradientCanvas.width = gradientCanvas.clientWidth;
    gradientCanvas.height = gradientCanvas.clientHeight;
    ctx.clearRect(0,0,gradientCanvas.width,gradientCanvas.height);

    ctx.fillStyle = document.body.classList.contains('dark') ? '#d6e1f0' : '#2e4036';
    ctx.font = getFontForCanvas(18);
    ctx.textAlign = 'center';
    ctx.fillText('√ò Steigung (hm/km)', gradientCanvas.width/2, 25);

    const selectedYear = filterYear.value;
    const allData = JSON.parse(localStorage.getItem('touren')) || [];

    const monthDist = Array(12).fill(0);
    const monthAsc = Array(12).fill(0);

    allData.forEach(entry => {
        if(!entry.date) return;

        const d = new Date(entry.date);
        if(selectedYear !== 'all' && d.getFullYear() !== Number(selectedYear)) return;

        const m = d.getMonth();

        monthDist[m] += parseFloat(entry.strecke?.toString().replace(',','.')) || 0;
        monthAsc[m] += parseFloat(entry.aufstieg?.toString().replace(',','.')) || 0;
    });

    const values = monthAsc.map((a,i)=>{
        return monthDist[i] > 0 ? a / monthDist[i] : 0;
    });

    drawBars(gradientCanvas, ctx, values, '', 0);
}

function drawToursDiagram(){

    const ctx = toursCanvas.getContext('2d');
    toursCanvas.width = toursCanvas.clientWidth;
    toursCanvas.height = toursCanvas.clientHeight;
    ctx.clearRect(0,0,toursCanvas.width,toursCanvas.height);

    // √úberschrift
    ctx.fillStyle = document.body.classList.contains('dark') ? '#d6e1f0' : '#2e4036';
    ctx.font = getFontForCanvas(18);
    ctx.textAlign = 'center';
    ctx.fillText('Anzahl Touren', toursCanvas.width/2, 25);

    const selectedYear = filterYear.value;
    const allData = JSON.parse(localStorage.getItem('touren')) || [];

    const monthCounts = Array(12).fill(0);

    allData.forEach(entry => {

        if(!entry.date) return;

        const d = new Date(entry.date);
        if(selectedYear !== 'all' && d.getFullYear() !== Number(selectedYear)) return;

        const m = d.getMonth();

        // üëâ Jede Tour = +1
        monthCounts[m]++;
    });

    drawBars(toursCanvas, ctx, monthCounts, '', 0);
}

function drawBars(canvas, ctx, values, unit, decimals){

    const paddingTop = 10;
    const padding = 40;
    const width = canvas.width - padding*2;
    const height = canvas.height - padding - paddingTop;
    const barWidth = width/12 - 10;
    const maxValue = Math.max(...values, 1);
    const maxPeakRatio = 0.5; // max. zus√§tzliche H√∂he √ºber Bar
    const maxBarHeight = height * (1 - maxPeakRatio);


    const barColor = document.body.classList.contains('dark') ? '#7a0d0d' : '#f9d77e';
    const textColor = document.body.classList.contains('dark') ? '#d6e1f0' : '#2e4036';

    values.forEach((value,i)=>{
        const intensity = value / maxValue;
        const x = padding + i*(barWidth+10);
        const barHeight = (value / maxValue) * maxBarHeight;
        const y = canvas.height - padding - barHeight;

let gradient = ctx.createLinearGradient(
    x,
    y + barHeight,  // unten
    x,
    y               // oben
);

if(document.body.classList.contains('dark')){

    // Schwarz ‚Üí Rot
    gradient.addColorStop(0, '#000000');
    gradient.addColorStop(0.2, '#3b0000');
    gradient.addColorStop(1, '#7a0d0d');

}else{

    // Gr√ºn ‚Üí Gelb
    gradient.addColorStop(0, '#6fbf73');
    gradient.addColorStop(0.4, '#a8d86a');
    gradient.addColorStop(1, '#f9d77e');
}

ctx.fillStyle = gradient;
drawMountainBar(ctx, x, y, barWidth, barHeight, i, intensity);
ctx.fill();

ctx.strokeStyle = 'rgba(255,255,255,0.15)';
ctx.lineWidth = 1;
ctx.stroke();



// Gloss-Highlight (nur oberer Teil)
const glossHeight = barHeight;

let gloss = ctx.createLinearGradient(
    x,
    y,
    x,
    y + glossHeight
);

gloss.addColorStop(0, 'rgba(255,255,255,0.35)');
gloss.addColorStop(1, 'rgba(255,255,255,0)');

ctx.fillStyle = gloss;

drawMountainBar(ctx, x, y, barWidth, glossHeight, i, intensity);
ctx.fill();


        if(value>0){
            ctx.save();
            ctx.translate(x+barWidth/2,y+barHeight/2);
            ctx.rotate(-Math.PI/2);
            ctx.fillStyle = textColor;
            ctx.font = getFontForCanvas(12);
            ctx.textAlign='center';
            ctx.textBaseline='middle';
            ctx.fillText(value.toFixed(decimals).replace('.',',')+unit,0,0);
            ctx.restore();
        }

        ctx.fillStyle=textColor;
        ctx.font= getFontForCanvas(12);
        ctx.textAlign='center';
        ctx.fillText(['J','F','M','A','M','J','J','A','S','O','N','D'][i],
        x+barWidth/2,canvas.height-padding+14);
    });

    ctx.strokeStyle=document.body.classList.contains('dark') ? '#d6e1f030' : '#2e403630';
    ctx.beginPath();
    ctx.moveTo(padding,canvas.height-padding);
    ctx.lineTo(canvas.width-padding,canvas.height-padding);
    ctx.stroke();
}

function drawMountainBar(ctx, x, y, width, height, seed, intensity){

    const r1 = seededRandom(seed);
    const r2 = seededRandom(seed+1);
    const r3 = seededRandom(seed+2);

    const steepness = 0.3 + intensity*0.7;

    const peakHeight = height * (0.2 + steepness*0.5);

    const peak1X = x + width*(0.25 + r2*0.15);
    const peak2X = x + width*(0.6 + r3*0.15);
    const saddleX = x + width*(0.45 + r1*0.1);

    const peak1Y = y - peakHeight*(0.5 + steepness*r2);
    const peak2Y = y - peakHeight*(0.5 + steepness*r3);
    const saddleY = y + peakHeight*(0.4 - intensity*0.3);

    ctx.beginPath();

    ctx.moveTo(x, y+height);

    ctx.lineTo(x, y+peakHeight);

    // Gipfel 1
    ctx.quadraticCurveTo(
        peak1X,
        peak1Y,
        saddleX,
        saddleY
    );

    // Gipfel 2
    ctx.quadraticCurveTo(
        peak2X,
        peak2Y,
        x+width,
        y+peakHeight
    );

    ctx.lineTo(x+width, y+height);

    ctx.closePath();
}

function seededRandom(seed){
    let x = Math.sin(seed) * 10000;
    return x - Math.floor(x);
}

// Event: Wenn Filter Jahr gewechselt wird, Diagramm neu zeichnen
filterYear.addEventListener('change', () => {
drawDistanceDiagram(); drawDiagram(); drawTimeDiagram(); drawPeaksDiagram(); drawSpeedDiagram(); drawGradientDiagram(); drawToursDiagram();
});

// Live redraw beim Darkmode wechseln
const themeBtn = document.getElementById('theme-toggle');
themeBtn.addEventListener('click', () => {
drawDistanceDiagram(); drawDiagram(); drawTimeDiagram(); drawPeaksDiagram(); drawSpeedDiagram(); drawGradientDiagram(); drawToursDiagram();
});

// -------------- Theme - Toggle ---------------
    const themeToggle = document.getElementById('theme-toggle');

    // gespeicherten Modus laden
    if(localStorage.getItem('theme') === 'dark'){
        document.body.classList.add('dark');
        themeToggle.textContent = '‚òÄÔ∏è';
    } else {
        themeToggle.textContent = 'üåô';
    }

    themeToggle.addEventListener('click', () => {
        const isDark = document.body.classList.toggle('dark');
        themeToggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        localStorage.setItem('theme', isDark ? 'dark' : 'light');

        // Diagramm neu zeichnen, falls sichtbar
        if (chartVisible) drawDistanceDiagram(); drawDiagram(); drawTimeDiagram(); drawPeaksDiagram(); drawToursDiagram();
    });

// ==================== TOUR PLANEN ====================
const planBox = document.querySelector('#tour-view .box:nth-child(1)');
const plannedBox = document.querySelector('#tour-view .box:nth-child(2)');

const planForm = document.getElementById('plan-form');
const planSaveBtn = document.getElementById('plan-save-btn');
const planTourname = document.getElementById('plan-tourname');
const planGipfelCount = document.getElementById('plan-gipfel-count');
const planGipfelDetails = document.getElementById('plan-gipfel-details');
const planStrecke = document.getElementById('plan-strecke');
const planAufstieg = document.getElementById('plan-aufstieg');
const planAusgangspunkt = document.getElementById('plan-ausgangspunkt');
const planZeit = document.getElementById('plan-zeit');
const plannedTableBody = document.querySelector('#planned-table tbody');

let plannedTours = [];

// ---------- Saison Auswahl initialisieren ----------
const monatVonSelect = document.getElementById('monat-von');
const monatBisSelect = document.getElementById('monat-bis');

if (monatVonSelect && monatBisSelect) {

    const monate = [
        'J√§nner','Februar','M√§rz','April','Mai','Juni',
        'Juli','August','September','Oktober','November','Dezember'
    ];

    monate.forEach((m, i) => {
        monatVonSelect.add(new Option(m, i + 1));
        monatBisSelect.add(new Option(m, i + 1));
    });

}

// Box-H√∂he korrekt anpassen (wie bei Alle Touren)
function updateBoxHeight(box){
    const content = box.querySelector('.box-content');
    if(box.classList.contains('active')){
        content.style.maxHeight = content.scrollHeight + 'px';
    }
}

const monthShort = ['J√§n','Feb','M√§r','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];

function formatSaison(monatVon, monatBis) {
    if (!monatVon || !monatBis) return '';

    const vonIndex = parseInt(monatVon, 10) - 1;
    const bisIndex = parseInt(monatBis, 10) - 1;

    if (vonIndex < 0 || bisIndex < 0) return '';

    return `${monthShort[vonIndex]}‚Äì${monthShort[bisIndex]}`;
}

// ---------- Gipfel Formular ----------
planGipfelCount.addEventListener('change', () => {
    planGipfelDetails.innerHTML = '';
    const count = +planGipfelCount.value;

    for(let i=1;i<=count;i++){
        planGipfelDetails.innerHTML += `
            <div class="form-group">
                <label>Gipfel ${i} Name:</label>
                <input type="text" data-name>
                <label>Gipfel ${i} Seeh√∂he (m):</label>
                <input type="text" inputmode="numeric" step="1" min="0" data-height>
            </div>
        `;
    }

    requestAnimationFrame(() => updateBoxHeight(planBox));
});

// ---------- Speichern ----------
planSaveBtn.addEventListener('click', () => {

    // Tour-Daten aus Formular
    const tourname = planTourname.value.trim();
    const strecke  = planStrecke.value.trim();
    const aufstieg = planAufstieg.value.trim();
    const ausgangspunkt = planAusgangspunkt.value.trim();
    const zeit     = planZeit.value.trim();
    const gipfel   = parseInt(planGipfelCount.value) || 0;

    const monatVon = monatVonSelect.value;
    const monatBis = monatBisSelect.value;

    // Pflichtfeld pr√ºfen
    if (!tourname) {
        alert('Tourname muss ausgef√ºllt sein!');
        return;
    }

    // Zahlen validieren
    const numberRegex = /^\d+([.,]\d+)?$/;
    if (strecke && !numberRegex.test(strecke)) { alert('Strecke muss eine Zahl sein.'); return; }
    if (aufstieg && !numberRegex.test(aufstieg)) { alert('Aufstieg muss eine Zahl sein.'); return; }

    // Zeit validieren
    const timeRegex = /^\d+:[0-5][0-9]$/;
    if (zeit && !timeRegex.test(zeit)) { alert('Zeit muss im Format h:mm sein.'); return; }

    // Gipfel-Details sammeln ‚Äì exakt wie Save-Button
    const gipfelDetails = [];
    const nameInputs = planGipfelDetails.querySelectorAll('[data-name]');
    const heightInputs = planGipfelDetails.querySelectorAll('[data-height]');
    nameInputs.forEach((el,i)=>{
        const name = el.value.trim();
        const hoehe = heightInputs[i].value.trim();
        if(name || hoehe) { gipfelDetails.push({ name, hoehe }); }
    });

    // Eintrag erstellen
    const entry = {
        tourname,
        monatVon,
        monatBis,
        strecke,
        aufstieg,
        ausgangspunkt,
        zeit,
        gipfel,
        gipfelDetails
    };

    // ‚úÖ Speicher 1:1 wie Save-Button ‚Äì nur eigener Key
    const plannedTours = JSON.parse(localStorage.getItem('plannedTours')) || [];
    plannedTours.push(entry);
    localStorage.setItem('plannedTours', JSON.stringify(plannedTours));

    // Tabelle 1:1 laden
    loadPlannedTours();

    // Formular zur√ºcksetzen wie Save-Button
    planForm.reset();
    planGipfelDetails.innerHTML = '';

    // Box einklappen wie Save-Button
    const box = planForm.closest('.box');
    if(box) {
        box.classList.remove('active');
        box.querySelector('.box-content').style.maxHeight = '0';
    }
});

// ---------- Tabelle ----------
function loadPlannedTours() {
    // geplante Touren aus localStorage laden
    plannedTours = JSON.parse(localStorage.getItem('plannedTours')) || [];

    // Tabelle leeren
    plannedTableBody.innerHTML = '';

    // Nach Saison sortieren
    plannedTours
            .sort((a, b) => {
        const ma = parseInt(a.monatVon) || 99;
        const mb = parseInt(b.monatVon) || 99;

        if (ma !== mb) return ma - mb;

        return a.tourname.localeCompare(b.tourname);
    })
        .forEach((t, i) => {

            // üîë eindeutiger Schl√ºssel f√ºr diese geplante Tour
            const key = [
                formatSaison(t.monatVon, t.monatBis), // Saison / Beste Zeit
                t.tourname,
                t.strecke,
                t.aufstieg,
                t.zeit
            ].join('|');

            // Zeile erstellen
            const tr = document.createElement('tr');
            tr.dataset.key = key;

            tr.innerHTML = `
                <td data-label="Nr.">${i + 1}</td>
                <td data-label="Saison">${formatSaison(t.monatVon, t.monatBis)}</td>
                <td data-label="Tour">${t.tourname}</td>
                <td data-label="Gipfel" class="gipfel-toggle" style="cursor:pointer;font-weight:600;">${t.gipfel}</td>
                <td data-label="Strecke"><span class="value">${t.strecke}</span></td>
                <td data-label="Aufstieg"><span class="value">${t.aufstieg}</span></td>
                <td data-label="Startpunkt">${t.ausgangspunkt}</td>
                <td data-label="Zeit"><span class="value">${t.zeit}</span></td>
                <td data-label="Aktion">
                    <button class="load-btn" title="Ins Formular √ºbernehmen">‚è≥</button>
                    <button class="delete-btn">‚úï</button></td>
            `;
            plannedTableBody.appendChild(tr);

            // Gipfel-Accordion
            if (t.gipfelDetails && t.gipfelDetails.length > 0) {
                const acc = document.createElement('tr');
                acc.innerHTML = `
                    <td colspan="9">
                        <div class="gipfel-accordion" style="display:none;">
                            ${t.gipfelDetails.map(g => `‚õ∞ ${g.name} ‚Äì ${g.hoehe} m`).join('<br>')}
                        </div>
                    </td>
                `;
                plannedTableBody.appendChild(acc);

                // Klick auf Gipfelzahl √∂ffnet Accordion
                tr.querySelector('.gipfel-toggle').addEventListener('click', () => {
                    const el = acc.querySelector('.gipfel-accordion');
                    el.style.display = el.style.display === 'block' ? 'none' : 'block';
                    requestAnimationFrame(() => updateBoxHeight(plannedBox));
                });
            }

            // Delete-Button
            tr.querySelector('.delete-btn').addEventListener('click', () => {
                const allPlanned = JSON.parse(localStorage.getItem('plannedTours')) || [];

                // Originaleintrag anhand aller Felder finden
                const originalIndex = allPlanned.findIndex(e =>
                    e.tourname === t.tourname &&
                    e.gipfel === t.gipfel &&
                    e.strecke === t.strecke &&
                    e.aufstieg === t.aufstieg &&
                    e.ausgangspunkt === t.ausgangspunkt &&
                    e.zeit === t.zeit
                );

                if (originalIndex > -1) {
                    allPlanned.splice(originalIndex, 1);
                    localStorage.setItem('plannedTours', JSON.stringify(allPlanned));
                    loadPlannedTours(); // Tabelle neu laden
                }
            });

            // Neuer Load-Button
            tr.querySelector('.load-btn').addEventListener('click', (e) => {
                const btn = e.currentTarget;
                btn.disabled = true;       // Button sperren w√§hrend Aktion
                btn.textContent = '‚è≥';     // Ladesymbol

                const entry = plannedTours[i];

                // Formularfelder f√ºllen
                document.getElementById('tourname').value = entry.tourname;
                document.getElementById('gipfel').value = entry.gipfel;
                document.getElementById('strecke').value = entry.strecke;
                document.getElementById('aufstieg').value = entry.aufstieg;
                document.getElementById('ausgangspunkt').value = entry.ausgangspunkt;
                document.getElementById('zeit').value = entry.zeit;

                // Dynamische Gipfeldetails √ºbertragen
                const count = parseInt(entry.gipfel);
                const container = document.getElementById('gipfel-details-container');
                container.innerHTML = '';
                if(count > 0 && entry.gipfelDetails){
                    container.style.display = 'flex';
                    for(let j=0;j<count;j++){
                        const div = document.createElement('div');
                        div.classList.add('form-group');
                        const g = entry.gipfelDetails[j];
                        div.innerHTML = `
                            <label>Gipfel ${j+1} Name:</label>
                            <input type="text" name="gipfel_name_${j+1}" value="${g ? g.name : ''}">
                            <label>Gipfel ${j+1} Seeh√∂he (m):</label>
                            <input type="text" name="gipfel_hoehe_${j+1}" value="${g ? g.hoehe : ''}">
                        `;
                        container.appendChild(div);
                    }
                } else {
                    container.style.display = 'none';
                }

                // L√∂schen nach √úbernahme
                const allPlanned = JSON.parse(localStorage.getItem('plannedTours')) || [];
                const originalIndex = allPlanned.findIndex(e =>
                    e.tourname === entry.tourname &&
                    e.gipfel === entry.gipfel &&
                    e.strecke === entry.strecke &&
                    e.aufstieg === entry.aufstieg &&
                    e.zeit === entry.zeit
                );
                if(originalIndex > -1){
                    allPlanned.splice(originalIndex,1);
                    localStorage.setItem('plannedTours', JSON.stringify(allPlanned));
                }

                // Tabelle neu laden
                loadPlannedTours();

                // Zum Tour speichern-Formular wechseln
                document.querySelector('#app-view').classList.add('visible');
                document.querySelector('#tour-view').classList.remove('visible');

                // 1Ô∏è‚É£ Box "Tour speichern" √∂ffnen
                const tourBox = document.querySelector('#app-view .box'); // erste Box im App-View
                if(!tourBox.classList.contains('active')){
                    tourBox.classList.add('active');
                    const content = tourBox.querySelector('.box-content');
                    content.style.maxHeight = content.scrollHeight + 'px';
                }

// ---------- Togglebutton zur√ºcksetzen ----------
const tourToggle = document.getElementById('tour-toggle');
const planBox = document.querySelector('#tour-view .box'); // Box, die der Toggle steuert

if (tourToggle && planBox) {
    // 1Ô∏è‚É£ Box als nicht aktiv markieren
    planBox.classList.remove('active');

    // 2Ô∏è‚É£ Symbol und ARIA-Label zur√ºcksetzen
    tourToggle.textContent = 'üß≠';
    tourToggle.setAttribute('aria-label', 'Planung anzeigen');

// WICHTIG: internal state f√ºr Toggle zur√ºcksetzen
currentView = 'app'; // <- das war vorher das Problem
}


                // Button wieder aktivieren
                setTimeout(()=>btn.disabled=false, 500);
            });

        });

    // Box-H√∂he anpassen
    requestAnimationFrame(() => updateBoxHeight(plannedBox));
    updatePlannedOverview();

    // üîÑ Mobile Tourenliste mit Tabelle synchronisieren
    syncMobilePlanTourListFromTable();

    // üîí Optional: H√∂he der Tourenlisten-Box korrekt setzen
    const listBox = document.getElementById('planned-tours-list');
    if (listBox && listBox.classList.contains('active')) {
        const content = listBox.querySelector('.box-content');
        requestAnimationFrame(() => {
            content.style.maxHeight = content.scrollHeight + 'px';
        });
    }
}

// --------------- mobile Plan-Liste --------------

function syncMobilePlanTourListFromTable() {
    const listBox = document.querySelector('#planned-tours-list');
    if (!listBox) return;

    const list = listBox.querySelector('.tour-list');
    const rows = document.querySelectorAll('#planned-table tbody tr');

    // Box mit der Tabelle der geplanten Touren
    const plannedTableBox = document.querySelector('#planned-table-wrapper')?.closest('.box');

    list.innerHTML = '';

    let visibleIndex = 0;

    rows.forEach(row => {
        // Zeilen ignorieren, die durch Filter ausgeblendet sind
        if (row.style.display === 'none') return;

        const cells = row.querySelectorAll('td');
        // Detailzeilen (Accordion) haben nur 1 td ‚Üí √ºberspringen
        if (cells.length < 3) return;

        const saisonText   = cells[1].textContent.trim(); // "Beste Zeit" / Saison
        const tourText     = cells[2].textContent.trim();
        const distanceText = cells[4].textContent.trim();
        const ascentText   = cells[5].textContent.trim();
        const timeText     = cells[7].textContent.trim();

        // Schl√ºssel genauso bauen wie in loadPlannedTours()
        const key = [
            saisonText,
            tourText,
            distanceText,
            ascentText,
            timeText
        ].join('|');

        visibleIndex++;

        const li = document.createElement('li');
        li.dataset.key = key;

        li.innerHTML = `
            <span class="tour-nr">${visibleIndex}.</span>
            <span class="tour-date">${saisonText}</span>
            <span class="tour-name">${tourText}</span>
        `;

        list.appendChild(li);

        // Klick-Handler: Liste schlie√üen, Tabellen-Box √∂ffnen, scrollen & highlighten
        li.addEventListener('click', () => {
            const targetRow = document.querySelector(
                `#planned-table tbody tr[data-key="${CSS.escape(key)}"]`
            );
            if (!targetRow) return;

            // 1. Box "Planned-Tourenliste" schlie√üen
            const listBoxContainer = listBox.closest('.box');
            if (listBoxContainer && listBoxContainer.classList.contains('active')) {
                listBoxContainer.classList.remove('active');
                const listContent = listBoxContainer.querySelector('.box-content');
                if (listContent) {
                    listContent.style.maxHeight = '0px';
                }
            }

            // 2. Box "Geplante Touren" √∂ffnen (falls n√∂tig), DANN scrollen
            openBoxIfNeeded(plannedTableBox, () => {
                targetRow.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });

                // 3. Rot highlighten (wie bei den gespeicherten Touren)
                targetRow.classList.add('highlight');
                setTimeout(() => {
                    targetRow.classList.remove('highlight');
                }, 1100); // leicht l√§nger als deine Animationsdauer
            });
        });
    });

    if (visibleIndex === 0) {
        list.innerHTML = '<li style="opacity:.6">Keine Touren</li>';
        return;
    }
}


function updatePlannedOverview() {
    const tours = plannedTours;

    let totalTours = tours.length;
    let totalPeaks = 0;
    let totalDistance = 0;
    let totalAscent = 0;
    let totalMinutes = 0;

    tours.forEach(t => {
        totalPeaks += parseInt(t.gipfel) || 0;
        totalDistance += parseFloat(t.strecke) || 0;
        totalAscent += parseInt(t.aufstieg) || 0;

        if (t.zeit) {
            const [h, m] = t.zeit.split(':').map(Number);
            totalMinutes += (h * 60 + m);
        }
    });

    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;

    document.getElementById('ov-total-tours').textContent = totalTours;
    document.getElementById('ov-total-peaks').textContent = totalPeaks;
    document.getElementById('ov-total-distance').textContent = totalDistance.toFixed(1);
    document.getElementById('ov-total-ascent').textContent = totalAscent;
    document.getElementById('ov-total-time').textContent =
        `${hours}:${String(minutes).padStart(2, '0')}`;
}

loadPlannedTours();

function getFontForCanvas(size) {
    // Mobile = kleiner als 768px
    if (window.innerWidth <= 768) {
        return `${size}px Nunito, sans-serif`;
    } else {
        return `${size}px Nunito, sans-serif`;
    }
}

// ---------------- Initialisierung ----------------
const allData = JSON.parse(localStorage.getItem('touren'))||[];
populateFilters(allData);
loadData();

</script>

<div class="footer-logo-wrapper">
    <img src="icons/Logo_white.png" class="footer-logo light-logo" alt="Berge mit See">
    <img src="icons/Logo_black.png" class="footer-logo dark-logo" alt="Berge mit See">
</div>

</body>
</html>

